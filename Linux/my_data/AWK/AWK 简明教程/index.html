<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html xmlns="http://www.w3.org/1999/xhtml"><head profile="http://gmpg.org/xfn/11"><title>AWK 简明教程</title><!-- Source is http://coolshell.cn/articles/9070.html -->



	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" >
	<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7">

	
	<link rel="alternate" type="application/rss+xml" title="RSS 2.0 - 所有文章" href="http://coolshell.cn/feed" >
	<link rel="alternate" type="application/rss+xml" title="RSS 2.0 - 所有评论" href="http://coolshell.cn/comments/feed" >
	<link rel="pingback" href="http://coolshell.cn/xmlrpc.php" ><!-- style START --><!-- default style -->
<STYLE type=text/css media=screen>@import url( index_files/style.css );</STYLE>
<!-- for translations -->
	
			<LINK rel=stylesheet type=text/css href="index_files/chinese.css" media=screen ><!-- style END --><!-- script START -->
		
	

	
	<script type="text/javascript" src="index_files/base.js" >
	<script type="text/javascript" src="index_files/menu.js" /><!-- script END -->
	

	<link rel="alternate" type="application/rss+xml" title="酷壳 - CoolShell.cn » AWK 简明教程 评论 Feed" href="http://coolshell.cn/articles/9070.html/feed" />
<link rel="stylesheet" id="wp-postratings-css" href="index_files/postratings-css.css" type="text/css" media="all" />
<link rel="stylesheet" id="wp-pagenavi-css" href="index_files/pagenavi-css.css" type="text/css" media="all" />
<script type="text/javascript" src="index_files/jquery.js" />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://coolshell.cn/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://coolshell.cn//wp-includes/wlwmanifest.xml" /> 
<link rel="prev" title="Linus：利用二级指针删除单向链表" href="http://coolshell.cn/articles/8990.html" />
<link rel="next" title="sed 简明教程" href="http://coolshell.cn/articles/9104.html" />
<meta name="generator" content="WordPress 3.5.1" />
<link rel= "shortlink"href="http://coolshell.cn/?p=9070" /><!-- All in One SEO Pack 1.6.15.3 by Michael Torbert of Semper Fi Web Design[326,385] -->


<meta name="keywords" content="awk,gawk,linux,shell,unix" />
<link rel="canonical" href="http://coolshell.cn/articles/9070.html" /><!-- /all in one seo pack -->

	<link href="index_files/SyntaxHighlighter.css" type="text/css" rel="stylesheet" /><!-- Start of StatCounter Code -->
		
	<script type="text/javascript">
	<!-- 
		var sc_project=8326668; 
		var sc_security="cccb27f2"; 
		var sc_invisible=1;
	//-->
	</script>
	<script type="text/javascript" src="index_files/counter_xhtml.js" >
<link rel="stylesheet" href="index_files/plain.css" /><meta id="syntaxhighlighteranchor" name="syntaxhighlighter-version" content="3.1.5" /><meta itemprop="name" content="AWK 简明教程" /><meta itemprop="description" content="有一些网友看了前两天的《Linux下应该知道的技巧》希望我能教教他们用awk和sed，所以，出现了这篇文章。我估计这些80后的年轻朋友可能对awk/sed这类上古神器有点陌生了，所以需要我这个老家伙来炒炒冷饭。况且，AWK是贝尔实验室1977年搞出来的文本出现神器，今年是蛇年，是AWK的本命年，而且年纪和我相仿，所以非常有必要为他写篇文章。

之所以叫AWK是因为其取了三位创始人&nbsp;Alfred..." /><meta itemprop="url" content="http://coolshell.cn/articles/9070.html" /><meta itemprop="bestRating" content="5" /><meta itemprop="ratingValue" content="4.81" /><meta itemprop="ratingCount" content="27" /></head><noscript /><body><div class="statcounter"><a title="web analytics" href="http://statcounter.com/"><img class="statcounter" src="http://c.statcounter.com/8326668/0/cccb27f2/1/" alt="web analytics" /></a></div>	
	<!-- End of StatCounter Code -->
<script type="text/javascript">
	window._wp_rp_static_base_url = 'http://dtmvdvtzf8rz0.cloudfront.net/static/';
	window._wp_rp_wp_ajax_url = "http://coolshell.cn/wp-admin/admin-ajax.php";
	window._wp_rp_plugin_version = '2.5';
	window._wp_rp_post_id = '9070';
	window._wp_rp_num_rel_posts = '8';
	window._wp_rp_blog_id = '9793678';
	window._wp_rp_ajax_img_src_url = 'http://t.related-posts.com/pageview/?';
	window._wp_rp_thumbnails = false;
	window._wp_rp_post_title = 'AWK+%E7%AE%80%E6%98%8E%E6%95%99%E7%A8%8B';
	window._wp_rp_post_tags = ['awk', 'gawk', 'linux', 'shell', 'unix', '%3F%3F%3F%3F', '%3F%3F%3F%3F', 'unix%2Flinux', 'awk', 'cat', 'weinberg', 'img', 'program', 'alt', 'left'];
	window._wp_rp_promoted_content = true;
	window._wp_rp_traffic_exchange = false;
</script>
<script type="text/javascript" src="index_files/pageview.js" async="" >


<!-- Start Of Script Generated By WP-PostViews -->
<script type="text/javascript">
/* < ![CDATA[
*/jQuery.ajax({type:'GET',url:'http://coolshell.cn/wp-admin/admin-ajax.php',data:'postviews_id=9070&action=postviews',cache:false});/* ]]> */
</script>
<!-- End Of Script Generated By WP-PostViews --><!-- wrap START --><!-- container START --><!-- header START --><!-- header END --><!-- navigation START --><!-- navigation END --><!-- content START --><!-- main START -->
<META name=GENERATOR content="MSHTML 11.00.9600.18015"></head>
<BODY>
<div id="wrap">
<div id="container">
<div id="content">
	<div id="main"><br >
<div class="post" id="post-9070">
		<h2>AWK 简明教程</h2>
		<div class="info">
			<span class="date">2013年2月17日</span>
			<span class="author"><a href="http://coolshell.cn/articles/author/haoel" title="由 陈皓 发布" rel="author">陈皓</a></span>										<span class="addcomment"><a href="http://coolshell.cn/articles/9070.html#respond">发表评论</a></span>
				<span class="comments"><a href="http://coolshell.cn/articles/9070.html#comments">阅读评论</a></span>
						<span class="comments"> 21,201 人阅读  &nbsp;  &nbsp;</span>
			<div class="fixed" >
		</div>
		<div class="content">
			<p><IMG class="alignright size-full wp-image-9093" alt="" src="index_files/awk.jpg" width=350 height=279 >有一些网友看了前两天的《<a title="应该知道的Linux技巧" href="http://coolshell.cn/articles/8883.html" target="_blank">Linux下应该知道的技巧</a>》希望我能教教他们用awk和sed，所以，出现了这篇文章。我估计这些80后的年轻朋友可能对awk/sed这类上古神器有点陌生了，所以需要我这个老家伙来炒炒冷饭。<strong>况且，AWK是贝尔实验室1977年搞出来的文本出现神器，今年是蛇年，是AWK的本命年，而且年纪和我相仿，所以非常有必要为他写篇文章</strong>。</p>
<p>之所以叫AWK是因为其取了三位创始人&nbsp;<a title="Alfred Aho" href="http://en.wikipedia.org/wiki/Alfred_Aho">Alfred Aho</a>，<a title="Peter J. Weinberger" href="http://en.wikipedia.org/wiki/Peter_J._Weinberger">Peter Weinberger</a>, 和&nbsp;<a title="Brian Kernighan" href="http://en.wikipedia.org/wiki/Brian_Kernighan">Brian Kernighan</a>&nbsp;的Family Name的首字符。要学AWK，就得提一提AWK的一本相当经典的书《<a href="http://plan9.bell-labs.com/cm/cs/awkbook/" rel="nofollow">The AWK Programming Language</a>》，它在<a href="http://book.douban.com/subject/1876898/" target="_blank">豆瓣上的评分</a>是9.4分！在<a href="http://www.amazon.cn/mn/detailApp/?asin=020107981X" target="_blank">亚马逊上居然卖1022.30元</a>。</p>
<p>我在这里的教程并不想面面俱到，本文和我之前的<a title="Go 语言简介（上）— 语法" href="http://coolshell.cn/articles/8460.html" target="_blank">Go语言简介</a>一样，全是示例，基本无废话。</p>
<p><strong>我只想达到两个目的：</strong></p>
<p style="TEXT-ALIGN: left; PADDING-LEFT: 30px"><strong>1）你可以在乘坐公交地铁上下班，或是在坐马桶拉大便时读完（保证是一泡大便的工夫）。</strong></p>
<p style="TEXT-ALIGN: left; PADDING-LEFT: 30px"><strong>2）我只想让这篇博文像一个火辣的脱衣舞女挑起你的兴趣，然后还要你自己去下工夫去撸。</strong></p>
<p>废话少说，我们开始脱吧（注：这里只是topless）。</p>
<h4>起步上台</h4>
<p>我从netstat命令中提取了如下信息作为用例：</p>
<p><span id="more-9070" ></p>
<pre class="brush: bash; title: ; notranslate" title="">$ cat netstat.txt<br >Proto Recv-Q Send-Q Local-Address          Foreign-Address             State<br >tcp        0      0 0.0.0.0:3306           0.0.0.0:*                   LISTEN<br >tcp        0      0 0.0.0.0:80             0.0.0.0:*                   LISTEN<br >tcp        0      0 127.0.0.1:9000         0.0.0.0:*                   LISTEN<br >tcp        0      0 coolshell.cn:80        124.205.5.146:18245         TIME_WAIT<br >tcp        0      0 coolshell.cn:80        61.140.101.185:37538        FIN_WAIT2<br >tcp        0      0 coolshell.cn:80        110.194.134.189:1032        ESTABLISHED<br >tcp        0      0 coolshell.cn:80        123.169.124.111:49809       ESTABLISHED<br >tcp        0      0 coolshell.cn:80        116.234.127.77:11502        FIN_WAIT2<br >tcp        0      0 coolshell.cn:80        123.169.124.111:49829       ESTABLISHED<br >tcp        0      0 coolshell.cn:80        183.60.215.36:36970         TIME_WAIT<br >tcp        0   4166 coolshell.cn:80        61.148.242.38:30901         ESTABLISHED<br >tcp        0      1 coolshell.cn:80        124.152.181.209:26825       FIN_WAIT1<br >tcp        0      0 coolshell.cn:80        110.194.134.189:4796        ESTABLISHED<br >tcp        0      0 coolshell.cn:80        183.60.212.163:51082        TIME_WAIT<br >tcp        0      1 coolshell.cn:80        208.115.113.92:50601        LAST_ACK<br >tcp        0      0 coolshell.cn:80        123.169.124.111:49840       ESTABLISHED<br >tcp        0      0 coolshell.cn:80        117.136.20.85:50025         FIN_WAIT2<br >tcp        0      0 :::22                  :::*                        LISTEN<br ></pre>
<p>下面是最简单最常用的awk示例，其输出第1列和第4例，</p>
<ul>
<li>其中单引号中的被大括号括着的就是awk的语句，注意，其只能被单引号包含。 
  
<li>其中的$1..$n表示第几例。注：$0表示整个行。</li>
</ul>
<pre class="brush: bash; highlight: [1]; title: ; notranslate" title="">$ awk '{print $1, $4}' netstat.txt<br >Proto Local-Address<br >tcp 0.0.0.0:3306<br >tcp 0.0.0.0:80<br >tcp 127.0.0.1:9000<br >tcp coolshell.cn:80<br >tcp coolshell.cn:80<br >tcp coolshell.cn:80<br >tcp coolshell.cn:80<br >tcp coolshell.cn:80<br >tcp coolshell.cn:80<br >tcp coolshell.cn:80<br >tcp coolshell.cn:80<br >tcp coolshell.cn:80<br >tcp coolshell.cn:80<br >tcp coolshell.cn:80<br >tcp coolshell.cn:80<br >tcp coolshell.cn:80<br >tcp coolshell.cn:80<br >tcp :::22</pre>
<p>我们再来看看awk的格式化输出，和C语言的printf没什么两样：</p>
<pre class="brush: bash; highlight: [1]; title: ; notranslate" title="">$ awk '{printf "%-8s %-8s %-8s %-18s %-22s %-15s\n",$1,$2,$3,$4,$5,$6}' netstat.txt<br >Proto    Recv-Q   Send-Q   Local-Address      Foreign-Address        State<br >tcp      0        0        0.0.0.0:3306       0.0.0.0:*              LISTEN<br >tcp      0        0        0.0.0.0:80         0.0.0.0:*              LISTEN<br >tcp      0        0        127.0.0.1:9000     0.0.0.0:*              LISTEN<br >tcp      0        0        coolshell.cn:80    124.205.5.146:18245    TIME_WAIT<br >tcp      0        0        coolshell.cn:80    61.140.101.185:37538   FIN_WAIT2<br >tcp      0        0        coolshell.cn:80    110.194.134.189:1032   ESTABLISHED<br >tcp      0        0        coolshell.cn:80    123.169.124.111:49809  ESTABLISHED<br >tcp      0        0        coolshell.cn:80    116.234.127.77:11502   FIN_WAIT2<br >tcp      0        0        coolshell.cn:80    123.169.124.111:49829  ESTABLISHED<br >tcp      0        0        coolshell.cn:80    183.60.215.36:36970    TIME_WAIT<br >tcp      0        4166     coolshell.cn:80    61.148.242.38:30901    ESTABLISHED<br >tcp      0        1        coolshell.cn:80    124.152.181.209:26825  FIN_WAIT1<br >tcp      0        0        coolshell.cn:80    110.194.134.189:4796   ESTABLISHED<br >tcp      0        0        coolshell.cn:80    183.60.212.163:51082   TIME_WAIT<br >tcp      0        1        coolshell.cn:80    208.115.113.92:50601   LAST_ACK<br >tcp      0        0        coolshell.cn:80    123.169.124.111:49840  ESTABLISHED<br >tcp      0        0        coolshell.cn:80    117.136.20.85:50025    FIN_WAIT2<br >tcp      0        0        :::22              :::*                   LISTEN</pre>
<h4>脱掉外套</h4>
<h5>过滤记录</h5>
<p>我们再来看看如何过滤记录（下面过滤条件为：第三列的值为0 &amp;&amp; 第6列的值为LISTEN）</p>
<pre class="brush: bash; highlight: [1]; title: ; notranslate" title="">$ awk '$3==0 &amp;&amp; $6=="LISTEN" ' netstat.txt<br >tcp        0      0 0.0.0.0:3306               0.0.0.0:*              LISTEN<br >tcp        0      0 0.0.0.0:80                 0.0.0.0:*              LISTEN<br >tcp        0      0 127.0.0.1:9000             0.0.0.0:*              LISTEN<br >tcp        0      0 :::22                      :::*                   LISTEN</pre>
<p>其中的“==”为比较运算符。其他比较运算符：!=, &gt;, &lt;, &gt;=, &lt;=</p>
<p>我们来看看各种过滤记录的方式：</p>
<pre class="brush: bash; highlight: [1]; title: ; notranslate" title="">$ awk ' $3&gt;0 {print $0}' netstat.txt<br >Proto Recv-Q Send-Q Local-Address          Foreign-Address             State<br >tcp        0   4166 coolshell.cn:80        61.148.242.38:30901         ESTABLISHED<br >tcp        0      1 coolshell.cn:80        124.152.181.209:26825       FIN_WAIT1<br >tcp        0      1 coolshell.cn:80        208.115.113.92:50601        LAST_ACK</pre>
<p>如果我们需要表头的话，我们可以引入内建变量NR：</p>
<pre class="brush: bash; highlight: [1]; title: ; notranslate" title="">$ awk '$3==0 &amp;&amp; $6=="LISTEN" || NR==1 ' netstat.txt<br >Proto Recv-Q Send-Q Local-Address          Foreign-Address             State<br >tcp        0      0 0.0.0.0:3306           0.0.0.0:*                   LISTEN<br >tcp        0      0 0.0.0.0:80             0.0.0.0:*                   LISTEN<br >tcp        0      0 127.0.0.1:9000         0.0.0.0:*                   LISTEN<br >tcp        0      0 :::22                  :::*                        LISTEN</pre>
<p>再加上格式化输出：</p>
<pre class="brush: bash; highlight: [1]; title: ; notranslate" title="">$ awk '$3==0 &amp;&amp; $6=="LISTEN" || NR==1 {printf "%-20s %-20s %s\n",$4,$5,$6}' netstat.txt<br >Local-Address        Foreign-Address      State<br >0.0.0.0:3306         0.0.0.0:*            LISTEN<br >0.0.0.0:80           0.0.0.0:*            LISTEN<br >127.0.0.1:9000       0.0.0.0:*            LISTEN<br >:::22                :::*                 LISTEN</pre>
<h5><strong>内建变量</strong></h5>
<p>说到了内建变量，我们可以来看看awk的一些内建变量：</p>
<table border="0" cellpadding="4" cellspacing="1">
<tbody>
<tr>
<td bgcolor="#ffffff">$0</td>
<td bgcolor="#ffffff">当前记录（这个变量中存放着整个行的内容）</td>
</tr>
<tr>
<td bgcolor="#ffffff">$1~$n</td>
<td bgcolor="#ffffff">当前记录的第n个字段，字段间由FS分隔</td>
</tr>
<tr>
<td bgcolor="#ffffff">FS</td>
<td bgcolor="#ffffff">输入字段分隔符 默认是空格或Tab</td>
</tr>
<tr>
<td bgcolor="#ffffff">NF</td>
<td bgcolor="#ffffff">当前记录中的字段个数，就是有多少列</td>
</tr>
<tr>
<td bgcolor="#ffffff">NR</td>
<td bgcolor="#ffffff">已经读出的记录数，就是行号，从1开始，如果有多个文件话，这个值也是不断累加中。</td>
</tr>
<tr>
<td bgcolor="#ffffff">FNR</td>
<td bgcolor="#ffffff">当前记录数，与NR不同的是，这个值会是各个文件自己的行号</td>
</tr>
<tr>
<td bgcolor="#ffffff">RS</td>
<td bgcolor="#ffffff">输入的记录分隔符， 默认为换行符</td>
</tr>
<tr>
<td bgcolor="#ffffff">OFS</td>
<td bgcolor="#ffffff">输出字段分隔符， 默认也是空格</td>
</tr>
<tr>
<td bgcolor="#ffffff">ORS</td>
<td bgcolor="#ffffff">输出的记录分隔符，默认为换行符</td>
</tr>
<tr>
<td bgcolor="#ffffff">FILENAME</td>
<td bgcolor="#ffffff">当前输入文件的名字</td>
</tr>
</tbody>
</table>
<p>怎么使用呢，比如：我们如果要输出行号：</p>
<pre class="brush: bash; highlight: [1]; title: ; notranslate" title="">$ awk '$3==0 &amp;&amp; $6=="ESTABLISHED" || NR==1 {printf "%02s %s %-20s %-20s %s\n",NR, FNR, $4,$5,$6}' netstat.txt<br >01 1 Local-Address        Foreign-Address      State<br >07 7 coolshell.cn:80      110.194.134.189:1032 ESTABLISHED<br >08 8 coolshell.cn:80      123.169.124.111:49809 ESTABLISHED<br >10 10 coolshell.cn:80      123.169.124.111:49829 ESTABLISHED<br >14 14 coolshell.cn:80      110.194.134.189:4796 ESTABLISHED<br >17 17 coolshell.cn:80      123.169.124.111:49840 ESTABLISHED</pre>
<h5><strong>指定分隔符</strong></h5>
<pre class="brush: bash; highlight: [1]; title: ; notranslate" title="">$  awk  'BEGIN{FS=":"} {print $1,$3,$6}' /etc/passwd<br >root 0 /root<br >bin 1 /bin<br >daemon 2 /sbin<br >adm 3 /var/adm<br >lp 4 /var/spool/lpd<br >sync 5 /sbin<br >shutdown 6 /sbin<br >halt 7 /sbin</pre>
<p>上面的命令也等价于：（-F的意思就是指定分隔符）</p>
<pre class="brush: bash; highlight: [1]; title: ; notranslate" title="">$ awk  -F: '{print $1,$3,$6}' /etc/passwd</pre>
<p>注：如果你要指定多个分隔符，你可以这样来：</p>
<pre class="brush: bash; title: ; notranslate" title="">awk -F '[;:]'</pre>
<p>再来看一个以\t作为分隔符输出的例子（下面使用了/etc/passwd文件，这个文件是以:分隔的）：</p>
<pre class="brush: bash; highlight: [1]; title: ; notranslate" title="">$ awk  -F: '{print $1,$3,$6}' OFS="\t" /etc/passwd<br >root    0       /root<br >bin     1       /bin<br >daemon  2       /sbin<br >adm     3       /var/adm<br >lp      4       /var/spool/lpd<br >sync    5       /sbin</pre>
<h4>脱掉衬衫</h4>
<h5>字符串匹配</h5>
<p>我们再来看几个字符串匹配的示例：</p>
<pre class="brush: bash; highlight: [1,8]; title: ; notranslate" title="">$ awk '$6 ~ /FIN/ || NR==1 {print NR,$4,$5,$6}' OFS="\t" netstat.txt<br >1       Local-Address   Foreign-Address State<br >6       coolshell.cn:80 61.140.101.185:37538    FIN_WAIT2<br >9       coolshell.cn:80 116.234.127.77:11502    FIN_WAIT2<br >13      coolshell.cn:80 124.152.181.209:26825   FIN_WAIT1<br >18      coolshell.cn:80 117.136.20.85:50025     FIN_WAIT2<br ><br >$ $ awk '$6 ~ /WAIT/ || NR==1 {print NR,$4,$5,$6}' OFS="\t" netstat.txt<br >1       Local-Address   Foreign-Address State<br >5       coolshell.cn:80 124.205.5.146:18245     TIME_WAIT<br >6       coolshell.cn:80 61.140.101.185:37538    FIN_WAIT2<br >9       coolshell.cn:80 116.234.127.77:11502    FIN_WAIT2<br >11      coolshell.cn:80 183.60.215.36:36970     TIME_WAIT<br >13      coolshell.cn:80 124.152.181.209:26825   FIN_WAIT1<br >15      coolshell.cn:80 183.60.212.163:51082    TIME_WAIT<br >18      coolshell.cn:80 117.136.20.85:50025     FIN_WAIT2</pre>
<p>上面的第一个示例匹配FIN状态， 第二个示例匹配WAIT字样的状态。其实 ~ 表示模式开始。/ /中是模式。这就是一个正则表达式的匹配。</p>
<p>其实awk可以像grep一样的去匹配第一行，就像这样：</p>
<pre class="brush: bash; highlight: [1]; title: ; notranslate" title="">$ awk '/LISTEN/' netstat.txt<br >tcp        0      0 0.0.0.0:3306            0.0.0.0:*               LISTEN<br >tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN<br >tcp        0      0 127.0.0.1:9000          0.0.0.0:*               LISTEN<br >tcp        0      0 :::22                   :::*                    LISTEN</pre>
<p>我们可以使用 “/FIN|TIME/” 来匹配 FIN 或者 TIME :</p>
<pre class="brush: bash; highlight: [1]; title: ; notranslate" title="">$ awk '$6 ~ /FIN|TIME/ || NR==1 {print NR,$4,$5,$6}' OFS="\t" netstat.txt<br >1       Local-Address   Foreign-Address State<br >5       coolshell.cn:80 124.205.5.146:18245     TIME_WAIT<br >6       coolshell.cn:80 61.140.101.185:37538    FIN_WAIT2<br >9       coolshell.cn:80 116.234.127.77:11502    FIN_WAIT2<br >11      coolshell.cn:80 183.60.215.36:36970     TIME_WAIT<br >13      coolshell.cn:80 124.152.181.209:26825   FIN_WAIT1<br >15      coolshell.cn:80 183.60.212.163:51082    TIME_WAIT<br >18      coolshell.cn:80 117.136.20.85:50025     FIN_WAIT2</pre>
<p>再来看看模式取反的例子：</p>
<pre class="brush: bash; highlight: [1]; title: ; notranslate" title="">$ awk '$6 !~ /WAIT/ || NR==1 {print NR,$4,$5,$6}' OFS="\t" netstat.txt<br >1       Local-Address   Foreign-Address State<br >2       0.0.0.0:3306    0.0.0.0:*       LISTEN<br >3       0.0.0.0:80      0.0.0.0:*       LISTEN<br >4       127.0.0.1:9000  0.0.0.0:*       LISTEN<br >7       coolshell.cn:80 110.194.134.189:1032    ESTABLISHED<br >8       coolshell.cn:80 123.169.124.111:49809   ESTABLISHED<br >10      coolshell.cn:80 123.169.124.111:49829   ESTABLISHED<br >12      coolshell.cn:80 61.148.242.38:30901     ESTABLISHED<br >14      coolshell.cn:80 110.194.134.189:4796    ESTABLISHED<br >16      coolshell.cn:80 208.115.113.92:50601    LAST_ACK<br >17      coolshell.cn:80 123.169.124.111:49840   ESTABLISHED<br >19      :::22   :::*    LISTEN</pre>
<p>或是：</p>
<pre class="brush: bash; title: ; notranslate" title="">awk '!/WAIT/' netstat.txt</pre>
<p><strong>折分文件</strong></p>
<p>awk拆分文件很简单，使用重定向就好了。下面这个例子，是按第6例分隔文件，相当的简单（其中的NR!=1表示不处理表头）。</p>
<pre class="brush: bash; highlight: [1]; title: ; notranslate" title="">$ awk 'NR!=1{print &gt; $6}' netstat.txt<br ><br >$ ls<br >ESTABLISHED  FIN_WAIT1  FIN_WAIT2  LAST_ACK  LISTEN  netstat.txt  TIME_WAIT<br ><br >$ cat ESTABLISHED<br >tcp        0      0 coolshell.cn:80        110.194.134.189:1032        ESTABLISHED<br >tcp        0      0 coolshell.cn:80        123.169.124.111:49809       ESTABLISHED<br >tcp        0      0 coolshell.cn:80        123.169.124.111:49829       ESTABLISHED<br >tcp        0   4166 coolshell.cn:80        61.148.242.38:30901         ESTABLISHED<br >tcp        0      0 coolshell.cn:80        110.194.134.189:4796        ESTABLISHED<br >tcp        0      0 coolshell.cn:80        123.169.124.111:49840       ESTABLISHED<br ><br >$ cat FIN_WAIT1<br >tcp        0      1 coolshell.cn:80        124.152.181.209:26825       FIN_WAIT1<br ><br >$ cat FIN_WAIT2<br >tcp        0      0 coolshell.cn:80        61.140.101.185:37538        FIN_WAIT2<br >tcp        0      0 coolshell.cn:80        116.234.127.77:11502        FIN_WAIT2<br >tcp        0      0 coolshell.cn:80        117.136.20.85:50025         FIN_WAIT2<br ><br >$ cat LAST_ACK<br >tcp        0      1 coolshell.cn:80        208.115.113.92:50601        LAST_ACK<br ><br >$ cat LISTEN<br >tcp        0      0 0.0.0.0:3306           0.0.0.0:*                   LISTEN<br >tcp        0      0 0.0.0.0:80             0.0.0.0:*                   LISTEN<br >tcp        0      0 127.0.0.1:9000         0.0.0.0:*                   LISTEN<br >tcp        0      0 :::22                  :::*                        LISTEN<br ><br >$ cat TIME_WAIT<br >tcp        0      0 coolshell.cn:80        124.205.5.146:18245         TIME_WAIT<br >tcp        0      0 coolshell.cn:80        183.60.215.36:36970         TIME_WAIT<br >tcp        0      0 coolshell.cn:80        183.60.212.163:51082        TIME_WAIT</pre>
<p>你也可以把指定的列输出到文件：</p>
<pre class="brush: bash; title: ; notranslate" title="">awk 'NR!=1{print $4,$5 &gt; $6}' netstat.txt</pre>
<p>再复杂一点：（注意其中的if-else-if语句，可见awk其实是个脚本解释器）</p>
<pre class="brush: bash; highlight: [1,2,3]; title: ; notranslate" title="">$ awk 'NR!=1{if($6 ~ /TIME|ESTABLISHED/) print &gt; "1.txt";<br >else if($6 ~ /LISTEN/) print &gt; "2.txt";<br >else print &gt; "3.txt" }' netstat.txt<br ><br >$ ls ?.txt<br >1.txt  2.txt  3.txt<br ><br >$ cat 1.txt<br >tcp        0      0 coolshell.cn:80        124.205.5.146:18245         TIME_WAIT<br >tcp        0      0 coolshell.cn:80        110.194.134.189:1032        ESTABLISHED<br >tcp        0      0 coolshell.cn:80        123.169.124.111:49809       ESTABLISHED<br >tcp        0      0 coolshell.cn:80        123.169.124.111:49829       ESTABLISHED<br >tcp        0      0 coolshell.cn:80        183.60.215.36:36970         TIME_WAIT<br >tcp        0   4166 coolshell.cn:80        61.148.242.38:30901         ESTABLISHED<br >tcp        0      0 coolshell.cn:80        110.194.134.189:4796        ESTABLISHED<br >tcp        0      0 coolshell.cn:80        183.60.212.163:51082        TIME_WAIT<br >tcp        0      0 coolshell.cn:80        123.169.124.111:49840       ESTABLISHED<br ><br >$ cat 2.txt<br >tcp        0      0 0.0.0.0:3306           0.0.0.0:*                   LISTEN<br >tcp        0      0 0.0.0.0:80             0.0.0.0:*                   LISTEN<br >tcp        0      0 127.0.0.1:9000         0.0.0.0:*                   LISTEN<br >tcp        0      0 :::22                  :::*                        LISTEN<br ><br >$ cat 3.txt<br >tcp        0      0 coolshell.cn:80        61.140.101.185:37538        FIN_WAIT2<br >tcp        0      0 coolshell.cn:80        116.234.127.77:11502        FIN_WAIT2<br >tcp        0      1 coolshell.cn:80        124.152.181.209:26825       FIN_WAIT1<br >tcp        0      1 coolshell.cn:80        208.115.113.92:50601        LAST_ACK<br >tcp        0      0 coolshell.cn:80        117.136.20.85:50025         FIN_WAIT2</pre>
<h5>统计</h5>
<p>下面的命令计算所有的C文件，CPP文件和H文件的文件大小总和。</p>
<pre class="brush: bash; title: ; notranslate" title="">$ ls -l  *.cpp *.c *.h | awk '{sum+=$5} END {print sum}'<br >2511401</pre>
<p>我们再来看一个统计各个connection状态的用法：（我们可以看到一些编程的影子了，大家都是程序员我就不解释了。注意其中的数组的用法）</p>
<pre class="brush: bash; highlight: [1]; title: ; notranslate" title="">$ awk 'NR!=1{a[$6]++;} END {for (i in a) print i ", " a[i];}' netstat.txt<br >TIME_WAIT, 3<br >FIN_WAIT1, 1<br >ESTABLISHED, 6<br >FIN_WAIT2, 3<br >LAST_ACK, 1<br >LISTEN, 4</pre>
<p>再来看看统计每个用户的进程的占了多少内存（注：sum的RSS那一列）</p>
<pre class="brush: bash; highlight: [1]; title: ; notranslate" title=""> $ ps aux | awk'NR!=1{a[$1]+=$6;} END { for(i in a) print i ", " a[i]"KB";}'<br >dbus, 540KB<br >mysql, 99928KB<br >www, 3264924KB<br >root, 63644KB<br >hchen, 6020KB</pre>
<h4>脱掉内衣</h4>
<h5>awk脚本</h5>
<p>在上面我们可以看到一个END关键字。END的意思是“处理完所有的行的标识”，即然说到了END就有必要介绍一下BEGIN，这两个关键字意味着执行前和执行后的意思，语法如下：</p>
<ul>
<li>BEGIN{ 这里面放的是执行前的语句 } 
  
<li>END {这里面放的是处理完所有的行后要执行的语句 } 
  
<li>{这里面放的是处理每一行时要执行的语句}</li>
</ul>
<p>为了说清楚这个事，我们来看看下面的示例：</p>
<p>假设有这么一个文件（学生成绩表）：</p>
<pre class="brush: bash; title: ; notranslate" title="">$ cat score.txt<br >Marry   2143 78 84 77<br >Jack    2321 66 78 45<br >Tom     2122 48 77 71<br >Mike    2537 87 97 95<br >Bob     2415 40 57 62</pre>
<p>我们的awk脚本如下（我没有写有命令行上是因为命令行上不易读，另外也在介绍另一种用法）：</p>
<pre class="brush: bash; title: ; notranslate" title="">$ cat cal.awk<br >#!/bin/awk -f<br >#运行前<br >BEGIN {<br >    math = 0<br >    english = 0<br >    computer = 0<br ><br >    printf "NAME    NO.   MATH  ENGLISH  COMPUTER   TOTAL\n"<br >    printf "---------------------------------------------\n"<br >}<br >#运行中<br >{<br >    math+=$3<br >    english+=$4<br >    computer+=$5<br >    printf "%-6s %-6s %4d %8d %8d %8d\n", $1, $2, $3,$4,$5, $3+$4+$5<br >}<br >#运行后<br >END {<br >    printf "---------------------------------------------\n"<br >    printf "  TOTAL:%10d %8d %8d \n", math, english, computer<br >    printf "AVERAGE:%10.2f %8.2f %8.2f\n", math/NR, english/NR, computer/NR<br >}</pre>
<p>我们来看一下执行结果：（也可以这样运行 ./cal.awk score.txt）</p>
<pre class="brush: bash; title: ; notranslate" title="">$ awk -f cal.awk score.txt<br >NAME    NO.   MATH  ENGLISH  COMPUTER   TOTAL<br >---------------------------------------------<br >Marry  2143     78       84       77      239<br >Jack   2321     66       78       45      189<br >Tom    2122     48       77       71      196<br >Mike   2537     87       97       95      279<br >Bob    2415     40       57       62      159<br >---------------------------------------------<br >  TOTAL:       319      393      350<br >AVERAGE:     63.80    78.60    70.00</pre>
<h5>环境变量</h5>
<p>即然说到了脚本，我们来看看怎么和环境变量交互：（使用-v参数和ENVIRON，使用ENVIRON的环境变量需要export）</p>
<pre class="brush: bash; highlight: [9]; title: ; notranslate" title="">$ x=5<br ><br >$ y=10<br >$ export y<br ><br >$ echo $x $y<br >5 10<br ><br >$ awk -v val=$x '{print $1, $2, $3, $4+val, $5+ENVIRON["y"]}' OFS="\t" score.txt<br >Marry   2143    78      89      87<br >Jack    2321    66      83      55<br >Tom     2122    48      82      81<br >Mike    2537    87      102     105<br >Bob     2415    40      62      72<br ></pre>
<h4>几个花活</h4>
<p>最后，我们再来看几个小例子：</p>
<pre class="brush: bash; title: ; notranslate" title="">#从file文件中找出长度大于80的行<br >awk 'length&gt;80' file<br ><br >#按连接数查看客户端IP<br >netstat -ntu | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -nr<br ><br >#打印99乘法表<br >  seq 9 | sed 'H;g' | awk-v RS='''{for(i=1;i&lt;=NF;i++)printf("%dx%d=%d%s", i, NR, i*NR, i==NR?"\n":"\t")}' </pre>
<h4>自己撸吧</h4>
<p>关于其中的一些知识点可以参看<a href="http://www.gnu.org/software/gawk/manual/gawk.html" target="_blank">gawk的手册</a>：</p>
<ul>
<li>内建变量，参看：<a href="http://www.gnu.org/software/gawk/manual/gawk.html#Built_002din-Variables" target="_blank">http://www.gnu.org/software/gawk/manual/gawk.html#Built_002din-Variables</a>
<li>流控方面，参看：<a href="http://www.gnu.org/software/gawk/manual/gawk.html#Statements" target="_blank">http://www.gnu.org/software/gawk/manual/gawk.html#Statements</a>
<li>内建函数，参看：<a href="http://www.gnu.org/software/gawk/manual/gawk.html#Built_002din" target="_blank">http://www.gnu.org/software/gawk/manual/gawk.html#Built_002din</a>
<li>正则表达式，参看：<a href="http://www.gnu.org/software/gawk/manual/gawk.html#Regexp" target="_blank">http://www.gnu.org/software/gawk/manual/gawk.html#Regexp</a></li>
</ul>
<p>（全文完）
</p><br >
<div style="MARGIN-BOTTOM: 5px; CLEAR: both; MARGIN-TOP: 5px" ><div style="FLOAT: left"><!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<a class="jiathis_button_tsina" >
<a class="jiathis_button_tqq" >
<a class="jiathis_button_tsohu" >
<a class="jiathis_button_t163" >
<a class="jiathis_button_douban" >
<a class="jiathis_button_renren" >
<a class="jiathis_button_zhuaxia" >
<a class="jiathis_button_fanfou" >
<a class="jiathis_button_twitter" >
<a class="jiathis_button_fb" >
<a class="jiathis_button_gmail" >
<a class="jiathis_button_linkedin" >
<a class="jiathis_button_friendfeed" >
<a class="jiathis_button_digg" >
<a href="http://www.jiathis.com/share?uid=1541368" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank" >
<a class="jiathis_counter_style" >
</div>
<script type="text/javascript">
var jiathis_config={
	data_track_clickback:true,
	summary:"",
	hideMore:false
}
</script>
<script type="text/javascript" src="index_files/jia.js" charset="utf-8" >
<!-- JiaThis Button END --></div><div style="clear: both; margin-top: 5px; margin-bottom: 5px;" />			<div class="fixed" />
		</div><br />
<br />
<div id="post-ratings-9070-loading" class="post-ratings-loading"><img src="index_files/loading.gif" alt="Loading ..." title="Loading ..." class="post-ratings-image" height="16" width="16" />&nbsp;Loading ...</div>
 
	</div>

	<!-- related posts START --><div class="fixed" />	<!-- related posts END -->

	<script type="text/javascript" src="index_files/comment.js" /><div id="postnavi">
		<span class="prev"><a href="http://coolshell.cn/articles/9104.html" rel="next">sed 简明教程</a></span>
		<span class="next"><a href="http://coolshell.cn/articles/8990.html" rel="prev">Linus：利用二级指针删除单向链表</a></span>
		<div class="fixed" />
	</div>


<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-7486123-1']);
_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>
	</div><!-- main END --><!-- sidebar START --><!-- sidebar END -->
	<div class="fixed" >
</div><!-- content END --><!-- footer START --><!-- footer END -->

</div><!-- container END -->
</div><!-- wrap END -->

<script class="javascript" src="index_files/shCore.js" >
<script class="javascript" src="index_files/shBrushCSharp.js" />
<script class="javascript" src="index_files/shBrushPhp.js" />
<script class="javascript" src="index_files/shBrushJScript.js" />
<script class="javascript" src="index_files/shBrushJava.js" />
<script class="javascript" src="index_files/shBrushVb.js" />
<script class="javascript" src="index_files/shBrushSql.js" />
<script class="javascript" src="index_files/shBrushXml.js" />
<script class="javascript" src="index_files/shBrushDelphi.js" />
<script class="javascript" src="index_files/shBrushPython.js" />
<script class="javascript" src="index_files/shBrushRuby.js" />
<script class="javascript" src="index_files/shBrushCss.js" />
<script class="javascript" src="index_files/shBrushCpp.js" />
<script class="javascript">
dp.SyntaxHighlighter.ClipboardSwf = 'http://coolshell.cn//wp-content/plugins/google-syntax-highlighter/Scripts/clipboard.swf';
dp.SyntaxHighlighter.HighlightAll('code');
</script>
<script type="text/javascript" src="index_files/shCore-1.js" >
<script type="text/javascript" src="index_files/shBrushBash.js" />
<script type="text/javascript">
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "http://coolshell.cn//wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.83c";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "http://coolshell.cn//wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.83c";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '帮助';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = '无法找到Brush：';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush不能设置 html-script选项';
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.defaults['toolbar'] = false;
	SyntaxHighlighter.all();
</script>
<script type="text/javascript">
/* <![CDATA[ */
var ratingsL10n = {"plugin_url":"http:\/\/coolshell.cn\/wp-content\/plugins\/wp-postratings","ajax_url":"http:\/\/coolshell.cn\/wp-admin\/admin-ajax.php","text_wait":"Please rate only 1 post at a time.","image":"stars_crystal","image_ext":"gif","max":"5","show_loading":"1","show_fading":"1","custom":"0"};
var ratings_mouseover_image=new Image();ratings_mouseover_image.src=ratingsL10n.plugin_url+"/images/"+ratingsL10n.image+"/rating_over."+ratingsL10n.image_ext;;
/* ]]> */
</script>
<script type="text/javascript" src="index_files/postratings-js.js" >
<script src="index_files/stat.php" language="JavaScript" charset="gb2312" />


<script src="index_files/jquery.min.js" />
<script src="index_files/jquery.bpopup-0.8.0.min.js" />

<script type="text/javascript">
;(function($) {
    $(function() {
        var url=document.referrer;
        if ( url && url.search("http://")>-1) {
            var refurl =  url.match(/:\/\/(.[^/]+)/)[1];
            if(refurl.indexOf("baidu.com")>-1){
                $('#nobaidu_dlg').bPopup();
            }
        }
    });

})(jQuery);
</script>



<div id="nobaidu_dlg" style="MIN-WIDTH: 450px; COLOR: rgb(0,0,0); PADDING-BOTTOM: 20px; PADDING-TOP: 20px; PADDING-LEFT: 20px; MIN-HEIGHT: 180px; DISPLAY: none; PADDING-RIGHT: 20px; BACKGROUND-COLOR: rgb(255,255,255)"><!--<span class="bClose" style="cursor:pointer; position:absolute; right:10px;top:5px;">x<span/>-->
    <IMG src="index_files/nobaidu.jpg" align=left >
     <p style="MARGIN-LEFT: 200px; MARGIN-TOP: 20px; LINE-HEIGHT: 30px">
     检测到你还在使用百度这个搜索引擎，<br >
     做为一个程序员，这是一种自暴自弃！<br >
     <br >
     </p>
     <p style="MARGIN-TOP: 20px" align="center">
     <b><a href="http://coolshell.cn/articles/7186.html">做环保的程序员，从不用百度开始！</a></b>
     </p>
</div><!-- Dynamic page generated in 0.496 seconds. --><!-- Cached page generated by WP-Super-Cache on 2013-03-06 09:18:20 --><!-- Compression = gzip --></SPAN></div></div></div></div></div></div>
<P>&nbsp;</P>
<P>&nbsp;</P></BODY></html>