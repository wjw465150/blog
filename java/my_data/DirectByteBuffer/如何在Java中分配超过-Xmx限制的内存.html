<html>
<head>
  <title>Evernote Export</title>
  <basefont face="Tahoma" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/270946 (zh-CN); Windows/6.1.7601 Service Pack 1;"/>
  <style>
    body, td {
      font-family: Tahoma;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="392"/>

<div>
<div style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><br/><div style="position: relative; max-width: 600px;"><div style="font-size: 16px"><div style="background-image: url(http://it.deepinmind.com/images/bg.jpg); background-color: rgb(146, 179, 162); font-size: 14px; text-shadow: rgba(255, 255, 255, 0.199219) 1px 1px 2px; background-position: 0px 0px; background-repeat: repeat repeat;"><div style="box-shadow: rgba(0, 0, 0, 0.0976563) 3px 3px 6px; background-color: rgb(227, 222, 216); background-position: 0px 0px;"><h2 style="font-family: Georgia, 'Hiragino Sans GB', 宋体; margin: 0px; padding: 0px; font-size: 24px; color: rgb(77, 77, 77); line-height: 32px; border-bottom-width: 4px; border-bottom-style: double; border-bottom-color: rgba(0, 0, 0, 0.09375);">如何在Java中分配超过-Xmx限制的内存</h2><div style="margin: 0px 0px 30px; padding: 0px; font-size: 14px; vertical-align: middle;"><span style="color: rgb(86, 86, 86); font-family: Georgia, 'Hiragino Sans GB', 宋体; line-height: 1.6;">本文主要介绍Java中几种分配内存的方法。我们会看到如何使用sun.misc.Unsafe来统一操作任意类型的内存。以前用C语言开发的同学通常都希望能在Java中通过较底层的接口来操作内存，他们一定会对本文中要讲的内容感兴趣。</span></div><p style="font-family: Georgia, 'Hiragino Sans GB', 宋体; margin: 1em 0px; padding: 0px; line-height: 1.6; color: rgb(86, 86, 86);">如果你对Java内存优化比较感兴趣，可以看下<a href="http://java-performance.info/overview-of-memory-saving-techniques-java/" style="margin:0px;padding:0px;color:rgb(145, 115, 107);text-decoration:none;">这篇文章</a>，以及它的姊妹篇：<a href="http://java-performance.info/memory-consumption-of-java-data-types-1/" style="margin:0px;padding:0px;color:rgb(145, 115, 107);text-decoration:none;">一</a>， <a href="http://it.deepinmind.com/java/2014/03/21/%E5%A6%82%E4%BD%95%E5%9C%A8Java%E4%B8%AD%E5%88%86%E9%85%8D%E8%B6%85%E8%BF%87-Xmx%E9%99%90%E5%88%B6%E7%9A%84%E5%86%85%E5%AD%98.html" style="margin:0px;padding:0px;color:rgb(145, 115, 107);text-decoration:none;">二</a>。http://java-performance.info/memory-consumption-of-java-data-types-2/</p><h3 style="font-family: Georgia, 'Hiragino Sans GB', 宋体; line-height: 1.6; margin: 0px; padding: 0px; font-size: 18px; color: rgb(77, 77, 77);">数组分配的上限</h3><p style="font-family: Georgia, 'Hiragino Sans GB', 宋体; margin: 1em 0px; padding: 0px; line-height: 1.6; color: rgb(86, 86, 86);">Java里数组的大小是受限制的，因为它使用的是int类型作为数组下标。这意味着你无法申请超过Integer.MAX_VALUE（2^31-1）大小的数组。这并不是说你申请内存的上限就是2G。你可以申请一个大一点的类型的数组。比如：</p><div style="font-family: Georgia, 'Hiragino Sans GB', 宋体; line-height: 1.6; margin: 0px; padding: 0px; position: relative;"><pre style="margin:0px;padding:10px;margin-bottom:1em;color:rgb(77, 77, 77);background-color:rgba(0, 0, 0, 0.0980392);overflow:auto;"><code style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;font-weight:bold;">final</span> <span style="margin:0px;padding:0px;color:rgb(68, 85, 136);font-weight:bold;">long</span><span style="margin:0px;padding:0px;font-weight:bold;">[]</span> <span style="margin:0px;padding:0px;">ar</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;font-weight:bold;">new</span> <span style="margin:0px;padding:0px;color:rgb(68, 85, 136);font-weight:bold;">long</span><span style="margin:0px;padding:0px;font-weight:bold;">[</span> <span style="margin:0px;padding:0px;">Integer</span><span style="margin:0px;padding:0px;font-weight:bold;">.</span><span style="margin:0px;padding:0px;color:rgb(0, 128, 128);">MAX_VALUE</span> <span style="margin:0px;padding:0px;font-weight:bold;">];</span></code><span style="color:rgba(255, 255, 255, 0.8);width:32px;height:32px;display:block;position:absolute;top:0px;left:-62px;background-image:-webkit-linear-gradient(0deg, rgb(68, 99, 93) 0%, rgb(68, 99, 93) 90%, rgb(38, 55, 51) 100%);font-size:12px;line-height:32px;text-align:center;background-position:initial initial;background-repeat:initial initial;">&lt;/&gt;</span></pre></div><p style="font-family: Georgia, 'Hiragino Sans GB', 宋体; margin: 1em 0px; padding: 0px; line-height: 1.6; color: rgb(86, 86, 86);">这个会分配16G -8字节，如果你设置的-Xmx参数足够大的话（通常你的堆至少得保留50%以上的空间，也就是说分配16G的内存，你得设置成-Xmx24G。这只是一般的规则，具体分配多大要看实际情况）。</p><p style="font-family: Georgia, 'Hiragino Sans GB', 宋体; margin: 1em 0px; padding: 0px; line-height: 1.6; color: rgb(86, 86, 86);">不幸的是，在Java里，由于数组元素的类型的限制，你操作起内存来会比较麻烦。在操作数组方面，ByteBuffer应该是最有用的一个类了，它提供了读写不同的Java类型的方法。它的缺点是，目标数组类型必须是byte[]，也就是说你分配的内存缓存最大只能是2G。</p><h3 style="font-family: Georgia, 'Hiragino Sans GB', 宋体; line-height: 1.6; margin: 0px; padding: 0px; font-size: 18px; color: rgb(77, 77, 77);">把所有数组都当作byte数组来进行操作</h3><p style="font-family: Georgia, 'Hiragino Sans GB', 宋体; margin: 1em 0px; padding: 0px; line-height: 1.6; color: rgb(86, 86, 86);">假设现在2G内存对我们来说远远不够，如果是16G的话还算可以。我们已经分配了一个long[]，不过我们希望把它当作byte数组来进行操作。在Java里我们得求助下C程序员的好帮手了——sun.misc.Unsafe。这个类有两组方法：getN(object, offset),这个方法是要从object偏移量为offset的位置获取一个指定类型的值并返回它，N在这里就是代表着那个要返回值的类型，而putN(Object,offset,value）方法就是要把一个值写到Object的offset的那个位置。</p><p style="font-family: Georgia, 'Hiragino Sans GB', 宋体; margin: 1em 0px; padding: 0px; line-height: 1.6; color: rgb(86, 86, 86);">不幸的是，这些方法只能获取或者设置某个类型的值。如果你从数组里拷贝数据，你还需要unsafe的另一个方法，copyMemory(srcObject, srcOffset, destObject,destOffet,count)。这和System.arraycopy的工作方式类似，不过它拷贝的是字节而不是数组元素。</p><p style="font-family: Georgia, 'Hiragino Sans GB', 宋体; margin: 1em 0px; padding: 0px; line-height: 1.6; color: rgb(86, 86, 86);">想通过sun.misc.Unsafe来访问数组的数据，你需要两个东西：</p><ul style="font-family: Georgia, 'Hiragino Sans GB', 宋体; line-height: 1.6; margin: 0px 0px 1em; padding: 0px 0px 0px 20px; list-style: disc;"><li style="margin:0px;padding:0px;line-height:24px;">数组对象里数据的偏移量</li><li style="margin:0px;padding:0px;line-height:24px;">拷贝的元素在数组数据里的偏移量</li></ul><p style="font-family: Georgia, 'Hiragino Sans GB', 宋体; margin: 1em 0px; padding: 0px; line-height: 1.6; color: rgb(86, 86, 86);">Arrays和Java别的对象一样，都有一个对象头，它是存储在实际的数据前面的。这个头的长度可以通过unsafe.arrayBaseOffset(T[].class)方法来获取到，这里T是数组元素的类型。数组元素的大小可以通过unsafe.arrayIndexScale(T[].class) 方法获取到。这也就是说要访问类型为T的第N个元素的话，你的偏移量offset应该是arrayOffset+N*arrayScale。</p><p style="font-family: Georgia, 'Hiragino Sans GB', 宋体; margin: 1em 0px; padding: 0px; line-height: 1.6; color: rgb(86, 86, 86);">你可以看下<a href="http://java-performance.info/various-methods-of-binary-serialization-in-java/" style="margin:0px;padding:0px;color:rgb(145, 115, 107);text-decoration:none;" target="_blank">这篇文章</a>里，UnsafeMemory类使用Unsafe访问内存的那个例子。</p><p style="font-family: Georgia, 'Hiragino Sans GB', 宋体; margin: 1em 0px; padding: 0px; line-height: 1.6; color: rgb(86, 86, 86);">我们来写个简单的例子吧。我们分配一个long数组，然后更新它里面的几个字节。我们把最后一个元素更新成-1（16进制的话是0xFFFF FFFF FFFF FFFF)，然再逐个清除这个元素的所有字节。</p><div style="font-family: Georgia, 'Hiragino Sans GB', 宋体; line-height: 1.6; margin: 0px; padding: 0px; position: relative;"><pre style="margin:0px;padding:10px;margin-bottom:1em;color:rgb(77, 77, 77);background-color:rgba(0, 0, 0, 0.0980392);overflow:auto;"><code style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;font-weight:bold;">final</span> <span style="margin:0px;padding:0px;color:rgb(68, 85, 136);font-weight:bold;">long</span><span style="margin:0px;padding:0px;font-weight:bold;">[]</span> <span style="margin:0px;padding:0px;">ar</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;font-weight:bold;">new</span> <span style="margin:0px;padding:0px;color:rgb(68, 85, 136);font-weight:bold;">long</span><span style="margin:0px;padding:0px;font-weight:bold;">[</span> <span style="margin:0px;padding:0px;color:rgb(0, 153, 153);">1000</span> <span style="margin:0px;padding:0px;font-weight:bold;">];</span><span style="margin:0px;padding:0px;font-weight:bold;">final</span> <span style="margin:0px;padding:0px;color:rgb(68, 85, 136);font-weight:bold;">int</span> <span style="margin:0px;padding:0px;">index</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;">ar</span><span style="margin:0px;padding:0px;font-weight:bold;">.</span><span style="margin:0px;padding:0px;color:rgb(0, 128, 128);">length</span> <span style="margin:0px;padding:0px;font-weight:bold;">-</span> <span style="margin:0px;padding:0px;color:rgb(0, 153, 153);">1</span><span style="margin:0px;padding:0px;font-weight:bold;">;</span><span style="margin:0px;padding:0px;">ar</span><span style="margin:0px;padding:0px;font-weight:bold;">[</span> <span style="margin:0px;padding:0px;">index</span> <span style="margin:0px;padding:0px;font-weight:bold;">]</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;font-weight:bold;">-</span><span style="margin:0px;padding:0px;color:rgb(0, 153, 153);">1</span><span style="margin:0px;padding:0px;font-weight:bold;">;</span> <span style="margin:0px;padding:0px;color:rgb(153, 153, 136);font-style:italic;">//FFFF FFFF FFFF FFFF</span>
 
<span style="margin:0px;padding:0px;">System</span><span style="margin:0px;padding:0px;font-weight:bold;">.</span><span style="margin:0px;padding:0px;color:rgb(0, 128, 128);">out</span><span style="margin:0px;padding:0px;font-weight:bold;">.</span><span style="margin:0px;padding:0px;color:rgb(0, 128, 128);">println</span><span style="margin:0px;padding:0px;font-weight:bold;">(</span> <span style="margin:0px;padding:0px;color:rgb(221, 17, 68);">&quot;Before change = &quot;</span> <span style="margin:0px;padding:0px;font-weight:bold;">+</span> <span style="margin:0px;padding:0px;">Long</span><span style="margin:0px;padding:0px;font-weight:bold;">.</span><span style="margin:0px;padding:0px;color:rgb(0, 128, 128);">toHexString</span><span style="margin:0px;padding:0px;font-weight:bold;">(</span> <span style="margin:0px;padding:0px;">ar</span><span style="margin:0px;padding:0px;font-weight:bold;">[</span> <span style="margin:0px;padding:0px;">index</span> <span style="margin:0px;padding:0px;font-weight:bold;">]</span> <span style="margin:0px;padding:0px;font-weight:bold;">));</span>
 
<span style="margin:0px;padding:0px;font-weight:bold;">for</span> <span style="margin:0px;padding:0px;font-weight:bold;">(</span> <span style="margin:0px;padding:0px;color:rgb(68, 85, 136);font-weight:bold;">long</span> <span style="margin:0px;padding:0px;">i</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;color:rgb(0, 153, 153);">0</span><span style="margin:0px;padding:0px;font-weight:bold;">;</span> <span style="margin:0px;padding:0px;">i</span> <span style="margin:0px;padding:0px;font-weight:bold;">&lt;</span> <span style="margin:0px;padding:0px;color:rgb(0, 153, 153);">8</span><span style="margin:0px;padding:0px;font-weight:bold;">;</span> <span style="margin:0px;padding:0px;font-weight:bold;">++</span><span style="margin:0px;padding:0px;">i</span> <span style="margin:0px;padding:0px;font-weight:bold;">)</span><span style="margin:0px;padding:0px;font-weight:bold;">{</span>
    <span style="margin:0px;padding:0px;">unsafe</span><span style="margin:0px;padding:0px;font-weight:bold;">.</span><span style="margin:0px;padding:0px;color:rgb(0, 128, 128);">putByte</span><span style="margin:0px;padding:0px;font-weight:bold;">(</span> <span style="margin:0px;padding:0px;">ar</span><span style="margin:0px;padding:0px;font-weight:bold;">,</span> <span style="margin:0px;padding:0px;">longArrayOffset</span> <span style="margin:0px;padding:0px;font-weight:bold;">+</span> <span style="margin:0px;padding:0px;color:rgb(0, 153, 153);">8L</span> <span style="margin:0px;padding:0px;font-weight:bold;">*</span> <span style="margin:0px;padding:0px;">index</span> <span style="margin:0px;padding:0px;font-weight:bold;">+</span> <span style="margin:0px;padding:0px;">i</span><span style="margin:0px;padding:0px;font-weight:bold;">,</span> <span style="margin:0px;padding:0px;font-weight:bold;">(</span><span style="margin:0px;padding:0px;color:rgb(68, 85, 136);font-weight:bold;">byte</span><span style="margin:0px;padding:0px;font-weight:bold;">)</span> <span style="margin:0px;padding:0px;color:rgb(0, 153, 153);">0</span><span style="margin:0px;padding:0px;font-weight:bold;">);</span>
    <span style="margin:0px;padding:0px;">System</span><span style="margin:0px;padding:0px;font-weight:bold;">.</span><span style="margin:0px;padding:0px;color:rgb(0, 128, 128);">out</span><span style="margin:0px;padding:0px;font-weight:bold;">.</span><span style="margin:0px;padding:0px;color:rgb(0, 128, 128);">println</span><span style="margin:0px;padding:0px;font-weight:bold;">(</span> <span style="margin:0px;padding:0px;color:rgb(221, 17, 68);">&quot;After change: i = &quot;</span> <span style="margin:0px;padding:0px;font-weight:bold;">+</span> <span style="margin:0px;padding:0px;">i</span> <span style="margin:0px;padding:0px;font-weight:bold;">+</span> <span style="margin:0px;padding:0px;color:rgb(221, 17, 68);">&quot;, val = &quot;</span>  <span style="margin:0px;padding:0px;font-weight:bold;">+</span>  <span style="margin:0px;padding:0px;">Long</span><span style="margin:0px;padding:0px;font-weight:bold;">.</span><span style="margin:0px;padding:0px;color:rgb(0, 128, 128);">toHexString</span><span style="margin:0px;padding:0px;font-weight:bold;">(</span> <span style="margin:0px;padding:0px;">ar</span><span style="margin:0px;padding:0px;font-weight:bold;">[</span> <span style="margin:0px;padding:0px;">index</span> <span style="margin:0px;padding:0px;font-weight:bold;">]</span> <span style="margin:0px;padding:0px;font-weight:bold;">));</span><span style="margin:0px;padding:0px;font-weight:bold;">}</span></code><span style="color:rgba(255, 255, 255, 0.8);width:32px;height:32px;display:block;position:absolute;top:0px;left:-62px;background-image:-webkit-linear-gradient(0deg, rgb(68, 99, 93) 0%, rgb(68, 99, 93) 90%, rgb(38, 55, 51) 100%);font-size:12px;line-height:32px;text-align:center;background-position:initial initial;background-repeat:initial initial;">&lt;/&gt;</span></pre></div><p style="font-family: Georgia, 'Hiragino Sans GB', 宋体; margin: 1em 0px; padding: 0px; line-height: 1.6; color: rgb(86, 86, 86);">想运行上面 这个例子的话，得在你的测试类里加上下面的静态代码块：</p><div style="font-family: Georgia, 'Hiragino Sans GB', 宋体; line-height: 1.6; margin: 0px; padding: 0px; position: relative;"><pre style="margin:0px;padding:10px;margin-bottom:1em;color:rgb(77, 77, 77);background-color:rgba(0, 0, 0, 0.0980392);overflow:auto;"><code style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;font-weight:bold;">private</span> <span style="margin:0px;padding:0px;font-weight:bold;">static</span> <span style="margin:0px;padding:0px;font-weight:bold;">final</span> <span style="margin:0px;padding:0px;">Unsafe</span> <span style="margin:0px;padding:0px;">unsafe</span><span style="margin:0px;padding:0px;font-weight:bold;">;</span><span style="margin:0px;padding:0px;font-weight:bold;">static</span><span style="margin:0px;padding:0px;font-weight:bold;">{</span>
    <span style="margin:0px;padding:0px;font-weight:bold;">try</span>
    <span style="margin:0px;padding:0px;font-weight:bold;">{</span>
        <span style="margin:0px;padding:0px;">Field</span> <span style="margin:0px;padding:0px;">field</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;">Unsafe</span><span style="margin:0px;padding:0px;font-weight:bold;">.</span><span style="margin:0px;padding:0px;color:rgb(0, 128, 128);">class</span><span style="margin:0px;padding:0px;font-weight:bold;">.</span><span style="margin:0px;padding:0px;color:rgb(0, 128, 128);">getDeclaredField</span><span style="margin:0px;padding:0px;font-weight:bold;">(</span><span style="margin:0px;padding:0px;color:rgb(221, 17, 68);">&quot;theUnsafe&quot;</span><span style="margin:0px;padding:0px;font-weight:bold;">);</span>
        <span style="margin:0px;padding:0px;">field</span><span style="margin:0px;padding:0px;font-weight:bold;">.</span><span style="margin:0px;padding:0px;color:rgb(0, 128, 128);">setAccessible</span><span style="margin:0px;padding:0px;font-weight:bold;">(</span><span style="margin:0px;padding:0px;font-weight:bold;">true</span><span style="margin:0px;padding:0px;font-weight:bold;">);</span>
        <span style="margin:0px;padding:0px;">unsafe</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;font-weight:bold;">(</span><span style="margin:0px;padding:0px;">Unsafe</span><span style="margin:0px;padding:0px;font-weight:bold;">)</span><span style="margin:0px;padding:0px;">field</span><span style="margin:0px;padding:0px;font-weight:bold;">.</span><span style="margin:0px;padding:0px;color:rgb(0, 128, 128);">get</span><span style="margin:0px;padding:0px;font-weight:bold;">(</span><span style="margin:0px;padding:0px;font-weight:bold;">null</span><span style="margin:0px;padding:0px;font-weight:bold;">);</span>
    <span style="margin:0px;padding:0px;font-weight:bold;">}</span>
    <span style="margin:0px;padding:0px;font-weight:bold;">catch</span> <span style="margin:0px;padding:0px;font-weight:bold;">(</span><span style="margin:0px;padding:0px;">Exception</span> <span style="margin:0px;padding:0px;">e</span><span style="margin:0px;padding:0px;font-weight:bold;">)</span>
    <span style="margin:0px;padding:0px;font-weight:bold;">{</span>
        <span style="margin:0px;padding:0px;font-weight:bold;">throw</span> <span style="margin:0px;padding:0px;font-weight:bold;">new</span> <span style="margin:0px;padding:0px;color:rgb(153, 0, 0);font-weight:bold;">RuntimeException</span><span style="margin:0px;padding:0px;font-weight:bold;">(</span><span style="margin:0px;padding:0px;">e</span><span style="margin:0px;padding:0px;font-weight:bold;">);</span>
    <span style="margin:0px;padding:0px;font-weight:bold;">}</span><span style="margin:0px;padding:0px;font-weight:bold;">}</span>
 
<span style="margin:0px;padding:0px;font-weight:bold;">private</span> <span style="margin:0px;padding:0px;font-weight:bold;">static</span> <span style="margin:0px;padding:0px;font-weight:bold;">final</span> <span style="margin:0px;padding:0px;color:rgb(68, 85, 136);font-weight:bold;">long</span> <span style="margin:0px;padding:0px;">longArrayOffset</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;">unsafe</span><span style="margin:0px;padding:0px;font-weight:bold;">.</span><span style="margin:0px;padding:0px;color:rgb(0, 128, 128);">arrayBaseOffset</span><span style="margin:0px;padding:0px;font-weight:bold;">(</span><span style="margin:0px;padding:0px;color:rgb(68, 85, 136);font-weight:bold;">long</span><span style="margin:0px;padding:0px;font-weight:bold;">[].</span><span style="margin:0px;padding:0px;color:rgb(0, 128, 128);">class</span><span style="margin:0px;padding:0px;font-weight:bold;">);</span></code><span style="color:rgba(255, 255, 255, 0.8);width:32px;height:32px;display:block;position:absolute;top:0px;left:-62px;background-image:-webkit-linear-gradient(0deg, rgb(68, 99, 93) 0%, rgb(68, 99, 93) 90%, rgb(38, 55, 51) 100%);font-size:12px;line-height:32px;text-align:center;background-position:initial initial;background-repeat:initial initial;">&lt;/&gt;</span></pre></div><p style="font-family: Georgia, 'Hiragino Sans GB', 宋体; margin: 1em 0px; padding: 0px; line-height: 1.6; color: rgb(86, 86, 86);">输出的结果是：</p><div style="font-family: Georgia, 'Hiragino Sans GB', 宋体; line-height: 1.6; margin: 0px; padding: 0px; position: relative;"><pre style="margin:0px;padding:10px;margin-bottom:1em;color:rgb(77, 77, 77);background-color:rgba(0, 0, 0, 0.0980392);overflow:auto;"><code style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;">Before</span> <span style="margin:0px;padding:0px;">change</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;">ffffffffffffffff</span><span style="margin:0px;padding:0px;">After</span> <span style="margin:0px;padding:0px;">change:</span> <span style="margin:0px;padding:0px;">i</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;color:rgb(0, 153, 153);">0</span><span style="margin:0px;padding:0px;font-weight:bold;">,</span> <span style="margin:0px;padding:0px;">val</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;">ffffffffffffff00</span><span style="margin:0px;padding:0px;">After</span> <span style="margin:0px;padding:0px;">change:</span> <span style="margin:0px;padding:0px;">i</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;color:rgb(0, 153, 153);">1</span><span style="margin:0px;padding:0px;font-weight:bold;">,</span> <span style="margin:0px;padding:0px;">val</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;">ffffffffffff0000</span><span style="margin:0px;padding:0px;">After</span> <span style="margin:0px;padding:0px;">change:</span> <span style="margin:0px;padding:0px;">i</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;color:rgb(0, 153, 153);">2</span><span style="margin:0px;padding:0px;font-weight:bold;">,</span> <span style="margin:0px;padding:0px;">val</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;">ffffffffff000000</span><span style="margin:0px;padding:0px;">After</span> <span style="margin:0px;padding:0px;">change:</span> <span style="margin:0px;padding:0px;">i</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;color:rgb(0, 153, 153);">3</span><span style="margin:0px;padding:0px;font-weight:bold;">,</span> <span style="margin:0px;padding:0px;">val</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;">ffffffff00000000</span><span style="margin:0px;padding:0px;">After</span> <span style="margin:0px;padding:0px;">change:</span> <span style="margin:0px;padding:0px;">i</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;color:rgb(0, 153, 153);">4</span><span style="margin:0px;padding:0px;font-weight:bold;">,</span> <span style="margin:0px;padding:0px;">val</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;">ffffff0000000000</span><span style="margin:0px;padding:0px;">After</span> <span style="margin:0px;padding:0px;">change:</span> <span style="margin:0px;padding:0px;">i</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;color:rgb(0, 153, 153);">5</span><span style="margin:0px;padding:0px;font-weight:bold;">,</span> <span style="margin:0px;padding:0px;">val</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;">ffff000000000000</span><span style="margin:0px;padding:0px;">After</span> <span style="margin:0px;padding:0px;">change:</span> <span style="margin:0px;padding:0px;">i</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;color:rgb(0, 153, 153);">6</span><span style="margin:0px;padding:0px;font-weight:bold;">,</span> <span style="margin:0px;padding:0px;">val</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;">ff00000000000000</span><span style="margin:0px;padding:0px;">After</span> <span style="margin:0px;padding:0px;">change:</span> <span style="margin:0px;padding:0px;">i</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;color:rgb(0, 153, 153);">7</span><span style="margin:0px;padding:0px;font-weight:bold;">,</span> <span style="margin:0px;padding:0px;">val</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;color:rgb(0, 153, 153);">0</span></code><span style="color:rgba(255, 255, 255, 0.8);width:32px;height:32px;display:block;position:absolute;top:0px;left:-62px;background-image:-webkit-linear-gradient(0deg, rgb(68, 99, 93) 0%, rgb(68, 99, 93) 90%, rgb(38, 55, 51) 100%);font-size:12px;line-height:32px;text-align:center;background-position:initial initial;background-repeat:initial initial;">&lt;/&gt;</span></pre></div><h3 style="font-family: Georgia, 'Hiragino Sans GB', 宋体; line-height: 1.6; margin: 0px; padding: 0px; font-size: 18px; color: rgb(77, 77, 77);">sun.misc.Unsafe的内存分配</h3><p style="font-family: Georgia, 'Hiragino Sans GB', 宋体; margin: 1em 0px; padding: 0px; line-height: 1.6; color: rgb(86, 86, 86);">上面也说过了，在纯Java里我们的能分配的内存大小是有限的。这个限制在Java的最初版本里就已经定下来了，那个时候人们都不敢相像分配好几个G的内存是什么情况。不过现在已经是大数据的时代了，我们需要更多的内存。在Java里，想获取更多的内存有两个方法：</p><ul style="font-family: Georgia, 'Hiragino Sans GB', 宋体; line-height: 1.6; margin: 0px 0px 1em; padding: 0px 0px 0px 20px; list-style: disc;"><li style="margin:0px;padding:0px;line-height:24px;">分配许多小块的内存，然后逻辑上把它们当作一块连续的大内存来使用。</li><li style="margin:0px;padding:0px;line-height:24px;">使用sun.misc.Unsafe.allcateMemory(long)来进行内存分配。</li></ul><p style="font-family: Georgia, 'Hiragino Sans GB', 宋体; margin: 1em 0px; padding: 0px; line-height: 1.6; color: rgb(86, 86, 86);">第一个方法只是从算法的角度来看比较有意思一点，所以我们还是来看下第二个方法。</p><p style="font-family: Georgia, 'Hiragino Sans GB', 宋体; margin: 1em 0px; padding: 0px; line-height: 1.6; color: rgb(86, 86, 86);">sun.misc.Unsafe提供了一组方法来进行内存的分配，重新分配，以及释放。它们和C的malloc/free方法很像：</p><ul style="font-family: Georgia, 'Hiragino Sans GB', 宋体; line-height: 1.6; margin: 0px 0px 1em; padding: 0px 0px 0px 20px; list-style: disc;"><li style="margin:0px;padding:0px;line-height:24px;">long Unsafe.allocateMemory(long size)——分配一块内存空间。这块内存可能会包含垃圾数据（没有自动清零）。如果分配失败的话会抛一个java.lang.OutOfMemoryError的异常。它会返回一个非零的内存地址（看下面的描述）。</li><li style="margin:0px;padding:0px;line-height:24px;">Unsafe.reallocateMemory(long address, long size)——重新分配一块内存，把数据从旧的内存缓冲区（address指向的地方）中拷贝到的新分配的内存块中。如果地址等于0，这个方法和allocateMemory的效果是一样的。它返回的是新的内存缓冲区的地址。</li><li style="margin:0px;padding:0px;line-height:24px;">Unsafe.freeMemory(long address)——释放一个由前面那两方法生成的内存缓冲区。如果address为0什么也不干 。</li></ul><p style="font-family: Georgia, 'Hiragino Sans GB', 宋体; margin: 1em 0px; padding: 0px; line-height: 1.6; color: rgb(86, 86, 86);">这些方法分配的内存应该在一个被称为单寄存器地址的模式下使用：Unsafe提供了一组只接受一个地址参数的方法（不像双寄存器模式，它们需要一个Object还有一个偏移量offset）。通过这种方式分配的内存可以比你在-Xmx的Java参数里配置的还要大。</p><h3 style="font-family: Georgia, 'Hiragino Sans GB', 宋体; line-height: 1.6; margin: 0px; padding: 0px; font-size: 18px; color: rgb(77, 77, 77);">注意：Unsafe分配出来的内存是无法进行垃圾回收的。你得把它当成一种正常的资源，自己去进行管理。</h3><p style="font-family: Georgia, 'Hiragino Sans GB', 宋体; margin: 1em 0px; padding: 0px; line-height: 1.6; color: rgb(86, 86, 86);">下面是使用Unsafe.allocateMemory分配内存的一个例子，同时它还检查了整个内存缓冲区是不是可读写的：</p><div style="font-family: Georgia, 'Hiragino Sans GB', 宋体; line-height: 1.6; margin: 0px; padding: 0px; position: relative;"><pre style="margin:0px;padding:10px;margin-bottom:1em;color:rgb(77, 77, 77);background-color:rgba(0, 0, 0, 0.0980392);overflow:auto;"><code style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;font-weight:bold;">final</span> <span style="margin:0px;padding:0px;color:rgb(68, 85, 136);font-weight:bold;">int</span> <span style="margin:0px;padding:0px;">size</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;">Integer</span><span style="margin:0px;padding:0px;font-weight:bold;">.</span><span style="margin:0px;padding:0px;color:rgb(0, 128, 128);">MAX_VALUE</span> <span style="margin:0px;padding:0px;font-weight:bold;">/</span> <span style="margin:0px;padding:0px;color:rgb(0, 153, 153);">2</span><span style="margin:0px;padding:0px;font-weight:bold;">;</span><span style="margin:0px;padding:0px;font-weight:bold;">final</span> <span style="margin:0px;padding:0px;color:rgb(68, 85, 136);font-weight:bold;">long</span> <span style="margin:0px;padding:0px;">addr</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;">unsafe</span><span style="margin:0px;padding:0px;font-weight:bold;">.</span><span style="margin:0px;padding:0px;color:rgb(0, 128, 128);">allocateMemory</span><span style="margin:0px;padding:0px;font-weight:bold;">(</span> <span style="margin:0px;padding:0px;">size</span> <span style="margin:0px;padding:0px;font-weight:bold;">);</span><span style="margin:0px;padding:0px;font-weight:bold;">try</span><span style="margin:0px;padding:0px;font-weight:bold;">{</span>
    <span style="margin:0px;padding:0px;">System</span><span style="margin:0px;padding:0px;font-weight:bold;">.</span><span style="margin:0px;padding:0px;color:rgb(0, 128, 128);">out</span><span style="margin:0px;padding:0px;font-weight:bold;">.</span><span style="margin:0px;padding:0px;color:rgb(0, 128, 128);">println</span><span style="margin:0px;padding:0px;font-weight:bold;">(</span> <span style="margin:0px;padding:0px;color:rgb(221, 17, 68);">&quot;Unsafe address = &quot;</span> <span style="margin:0px;padding:0px;font-weight:bold;">+</span> <span style="margin:0px;padding:0px;">addr</span> <span style="margin:0px;padding:0px;font-weight:bold;">);</span>
    <span style="margin:0px;padding:0px;font-weight:bold;">for</span> <span style="margin:0px;padding:0px;font-weight:bold;">(</span> <span style="margin:0px;padding:0px;color:rgb(68, 85, 136);font-weight:bold;">int</span> <span style="margin:0px;padding:0px;">i</span> <span style="margin:0px;padding:0px;font-weight:bold;">=</span> <span style="margin:0px;padding:0px;color:rgb(0, 153, 153);">0</span><span style="margin:0px;padding:0px;font-weight:bold;">;</span> <span style="margin:0px;padding:0px;">i</span> <span style="margin:0px;padding:0px;font-weight:bold;">&lt;</span> <span style="margin:0px;padding:0px;">size</span><span style="margin:0px;padding:0px;font-weight:bold;">;</span> <span style="margin:0px;padding:0px;font-weight:bold;">++</span><span style="margin:0px;padding:0px;">i</span> <span style="margin:0px;padding:0px;font-weight:bold;">)</span>
    <span style="margin:0px;padding:0px;font-weight:bold;">{</span>
        <span style="margin:0px;padding:0px;">unsafe</span><span style="margin:0px;padding:0px;font-weight:bold;">.</span><span style="margin:0px;padding:0px;color:rgb(0, 128, 128);">putByte</span><span style="margin:0px;padding:0px;font-weight:bold;">(</span> <span style="margin:0px;padding:0px;">addr</span> <span style="margin:0px;padding:0px;font-weight:bold;">+</span> <span style="margin:0px;padding:0px;">i</span><span style="margin:0px;padding:0px;font-weight:bold;">,</span> <span style="margin:0px;padding:0px;font-weight:bold;">(</span><span style="margin:0px;padding:0px;color:rgb(68, 85, 136);font-weight:bold;">byte</span><span style="margin:0px;padding:0px;font-weight:bold;">)</span> <span style="margin:0px;padding:0px;color:rgb(0, 153, 153);">123</span><span style="margin:0px;padding:0px;font-weight:bold;">);</span>
        <span style="margin:0px;padding:0px;font-weight:bold;">if</span> <span style="margin:0px;padding:0px;font-weight:bold;">(</span> <span style="margin:0px;padding:0px;">unsafe</span><span style="margin:0px;padding:0px;font-weight:bold;">.</span><span style="margin:0px;padding:0px;color:rgb(0, 128, 128);">getByte</span><span style="margin:0px;padding:0px;font-weight:bold;">(</span> <span style="margin:0px;padding:0px;">addr</span> <span style="margin:0px;padding:0px;font-weight:bold;">+</span> <span style="margin:0px;padding:0px;">i</span> <span style="margin:0px;padding:0px;font-weight:bold;">)</span> <span style="margin:0px;padding:0px;font-weight:bold;">!=</span> <span style="margin:0px;padding:0px;color:rgb(0, 153, 153);">123</span> <span style="margin:0px;padding:0px;font-weight:bold;">)</span>
            <span style="margin:0px;padding:0px;">System</span><span style="margin:0px;padding:0px;font-weight:bold;">.</span><span style="margin:0px;padding:0px;color:rgb(0, 128, 128);">out</span><span style="margin:0px;padding:0px;font-weight:bold;">.</span><span style="margin:0px;padding:0px;color:rgb(0, 128, 128);">println</span><span style="margin:0px;padding:0px;font-weight:bold;">(</span> <span style="margin:0px;padding:0px;color:rgb(221, 17, 68);">&quot;Failed at offset = &quot;</span> <span style="margin:0px;padding:0px;font-weight:bold;">+</span> <span style="margin:0px;padding:0px;">i</span> <span style="margin:0px;padding:0px;font-weight:bold;">);</span>
    <span style="margin:0px;padding:0px;font-weight:bold;">}</span><span style="margin:0px;padding:0px;font-weight:bold;">}</span><span style="margin:0px;padding:0px;font-weight:bold;">finally</span><span style="margin:0px;padding:0px;font-weight:bold;">{</span>
    <span style="margin:0px;padding:0px;">unsafe</span><span style="margin:0px;padding:0px;font-weight:bold;">.</span><span style="margin:0px;padding:0px;color:rgb(0, 128, 128);">freeMemory</span><span style="margin:0px;padding:0px;font-weight:bold;">(</span> <span style="margin:0px;padding:0px;">addr</span> <span style="margin:0px;padding:0px;font-weight:bold;">);</span><span style="margin:0px;padding:0px;font-weight:bold;">}</span></code><span style="color:rgba(255, 255, 255, 0.8);width:32px;height:32px;display:block;position:absolute;top:0px;left:-62px;background-image:-webkit-linear-gradient(0deg, rgb(68, 99, 93) 0%, rgb(68, 99, 93) 90%, rgb(38, 55, 51) 100%);font-size:12px;line-height:32px;text-align:center;background-position:initial initial;background-repeat:initial initial;">&lt;/&gt;</span></pre></div><p style="font-family: Georgia, 'Hiragino Sans GB', 宋体; margin: 1em 0px; padding: 0px; line-height: 1.6; color: rgb(86, 86, 86);">正如你所看见的，使用sun.misc.Unsafe你可以写出非常通用的内存访问的代码：不管是Java里分配的何种内存，你都可以随意读写任意类型的数据。</p><p style="font-family: Georgia, 'Hiragino Sans GB', 宋体; margin: 1em 0px; padding: 0px; line-height: 1.6; color: rgb(86, 86, 86);">原创文章转载请注明出处：<a href="http://it.deepinmind.com/java/2014/03/21/%E5%A6%82%E4%BD%95%E5%9C%A8Java%E4%B8%AD%E5%88%86%E9%85%8D%E8%B6%85%E8%BF%87-Xmx%E9%99%90%E5%88%B6%E7%9A%84%E5%86%85%E5%AD%98.html" style="margin:0px;padding:0px;color:rgb(145, 115, 107);text-decoration:none;" target="_blank">如何在Java中分配超过-Xmx限制的内存</a></p><p style="font-family: Georgia, 'Hiragino Sans GB', 宋体; margin: 1em 0px; padding: 0px; line-height: 1.6; color: rgb(86, 86, 86);"><a href="http://java-performance.info/memory-allocation-in-java/" style="margin:0px;padding:0px;color:rgb(145, 115, 107);text-decoration:none;" target="_blank">英文原文链接</a></p></div></div></div></div></div>
</div></body></html> 