<!DOCTYPE html><!--
 ______________ 
< TUICOOL.COM >
 -------------- 
        \   ^__^
         \  (**)\__$__$__
            (__)\       )\/\
             U  ||------|
                ||     ||
--><html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta content="authenticity_token" name="csrf-param">
<meta content="dvU4hlQwydKwjg6RUz/gkv3U3yr24cQkDmjfFW6HhM0=" name="csrf-token">
    <title>
            java在线问题排查利器之Btrace&amp;Greys - 推酷
   </title>
    <meta name="description" content="java在线问题排查利器之Btrace&amp;Greys">
  <link rel="shortcut icon" href="urn:not-loaded:https://static0.tuicool.com/favicon.ico" type="image/x-icon">
  <link href="https://static0.tuicool.com/images/icon114.png" rel="Bookmark">
  <link rel="apple-touch-icon" sizes="57x57" href="urn:not-loaded:https://static1.tuicool.com/images/icon57.png">
  <link rel="apple-touch-icon" sizes="72x72" href="urn:not-loaded:https://static2.tuicool.com/images/icon72.png">
  <link rel="apple-touch-icon" sizes="114x114" href="urn:not-loaded:https://static0.tuicool.com/images/icon114.png">
  <link rel="apple-touch-icon" sizes="144x144" href="urn:not-loaded:https://static1.tuicool.com/images/icon144.png">
  <link href="index_files/pub.css" rel="stylesheet">
  <link href="index_files/application-c0585331e3c13ddf719e006bdaa6ca2e.css" media="screen" rel="stylesheet" type="text/css">
  <link href="index_files/font-awesome1.min.css" rel="stylesheet">
  <script type="text/javascript" src="index_files/pub.js"></script>
  <script src="index_files/application-2c6232a2f1d2d02d3efb47e836648248.js" type="text/javascript"></script>
  
      <style type="text/css"><!--
/* Effective stylesheet produced by snapshot save */
.load-fail { display: none; }
--></style>

</head>
<body class="  pace-done"><div class="pace  pace-inactive"><div class="pace-progress" style="transform: translate3d(100%, 0px, 0px);" data-progress-text="100%" data-progress="99">
  <div class="pace-progress-inner"></div>
</div>
<div class="pace-activity"></div></div>
  
  <div id="header" class="navbar-fixed-top">
    <div class="container">
      <div class="navbar">
        <div class="navbar-inner">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"> 
            <span class="icon-bar"></span> 
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span> 
          </a>
          <a href="https://www.tuicool.com/" class="brand">推酷</a>        
        <nav class="nav-collapse collapse">
            <ul class="nav navbar primary-nav">                            
              <li class="active">
                <a href="https://www.tuicool.com/ah">
                  文章
                </a>
              </li>              
              <li class="">
                <a href="https://www.tuicool.com/sites/hot">
                  站点
                </a>
              </li>
              <li class="">
                <a href="https://www.tuicool.com/topics">
                  主题
                </a>
              </li>
              <li class="">
                <a href="https://huodong.tuicool.com/">
                  活动
                </a>
              </li>
              <li class="">
                <a href="https://www.tuicool.com/mobile">
                  APP
                    <sup style="font-size:0.8em;color: #16A085;">荐</sup>
                </a>
              </li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">周刊 <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li><a href="https://www.tuicool.com/mags">编程狂人</a></li>
                  <li><a href="https://www.tuicool.com/mags/design">设计匠艺</a></li> 
                  <li><a href="https://www.tuicool.com/mags/startup">创业周刊</a></li> 
                  <li><a href="https://www.tuicool.com/mags/tech">科技周刊</a></li>      
                  <li><a href="https://www.tuicool.com/articles/weekly">一周拾遗</a></li>
                </ul>
              </li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">更多 <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li><a href="https://www.tuicool.com/daily_news">今日酷闻</a></li>
                  <li><a href="https://www.tuicool.com/bbs/go/issues">意见反馈</a></li>
                </ul>
              </li>
              </ul>
            <form class="navbar-search pull-left" action="https://www.tuicool.com/search">
              <input class="search-query span2" name="kw" placeholder="搜索" type="text">
            </form>
            <ul class="nav pull-right">
                <li><a href="https://www.tuicool.com/login">登录</a></li>
            </ul>
          </nav>
        </div>
      </div>
  </div>   
</div>
  <div id="flash_container" class="noPrint">    
  </div>
  
  <div class="container-fluid">  
      
<div class="row-fluid article_row_fluid">
    <div class="span8 contant article_detail_bg">
        <h1>java在线问题排查利器之Btrace&amp;Greys</h1>
        <div class="article_meta">
            <div style="margin-bottom: 5px;">
            <span class="timestamp">时间 2017-10-12 01:42:34
            </span>
            <span class="from">
                <i class="icon-globe"></i>
                    <a class="cut cut28 from" href="https://www.tuicool.com/sites/RBjIvia" target="_blank">网易乐得技术团队
                    </a>
            </span>
            </div>
            <div class="source">
                <i style="float:left;">原文</i>  
                <a class="cut cut70" href="http://tech.lede.com/2017/10/11/rd/server/javaToolsBTrace/?utm_source=tuicool&amp;utm_medium=referral" style="display:inline-block;">http://tech.lede.com/2017/10/11/rd/server/javaToolsBTrace/</a>
            </div>
            <div>
                <span>主题</span>
                <a href="https://www.tuicool.com/topics/11070092" target="_blank">
                    <span class="new-label">BTrace</span>
                </a>
            </div>
        </div>
        <div class="article_body" id="nei">
            <div> 
 <p>前段时间升级了urs新的远程cookie校验模式。功能上线后，发现涉及用户cookie 校验的接口，有时会报接口超时。通过日志埋点方式，确认了与urs提供的jar包内的新验证方法有关。通过反编译，看到相关方法执行过程中涉及参数校验、参数组装、远程访问校验、本地校验等步骤，究竟哪个步骤出了问题？</p> 
 <p> 一种方式是让urs帮忙提供一个新的jar包，在关键步骤处加日志，记录执行时间，另一种方法，就是使用一些在线分析工具。显然第二种方式更方便快捷。本文主要介绍两款在线问题排的工具： <strong>Btrace</strong> 和 <strong>Greys</strong> 。 </p> 
 <h2>2. 工具简介 </h2> 
 <p> Btrace和 <strong>Greys</strong> 都比较适合对生成环境的问题进行排查，都属于“事后工具” ，即服务已经上线了，无法再通过打印日志等方式埋点分析。这时可以使用这些工具，来跟踪代码执行耗时、堆栈情况等。 </p> 
 <h4>原理</h4> 
 <p>都是基于动态字节码修改技术(Hotswap)来实现运行时 java 程序的跟踪和替换。</p> 
 <p>利用了Java SE 6 新特性Instrumentation 。</p> 
 <h4>使用场景</h4> 
 <ul> 
  <li>分析哪些方法慢，查询具体的故障点；</li> 
  <li>查看方法的参数、返回值；</li> 
  <li>查看对象属性等；</li> 
 </ul> 
 <h4>Btrace 和 Greys</h4> 
 <p>Btrace 和 Greys 都属于工具，本文以实例，介绍如何使用，不再对其本身进行介绍，如果想进一步了解，可以直接去下面的链接：</p> 
 <table class="table table-bordered"> 
  <thead> 
   <tr> 
    <th width="15%">类型</th> 
    <th>介绍</th> 
   </tr> 
  </thead> 
  <tbody> 
   <tr> 
    <td>Btrace</td> 
    <td> <a href="https://github.com/btraceio/btrace/wiki" target="_blank" rel="nofollow,noindex">https://github.com/btraceio/btrace/wiki</a> </td> 
   </tr> 
   <tr> 
    <td>Greys介绍</td> 
    <td> <a href="https://yq.aliyun.com/articles/2390" target="_blank" rel="nofollow,noindex">https://yq.aliyun.com/articles/2390</a> </td> 
   </tr> 
  </tbody> 
 </table> 
 <h2>3. 实例-使用工具排查问题 </h2> 
 <p>urs新提供了远程cookie的校验jar包，其中关键的方法为远程调用方法</p> 
 <p>CookieDecoder.requestDecode(**)，我们主要对这个方法进行跟踪。</p> 
 <h3>3.1 使用Btrace </h3> 
 <p>由于我们的tomcat 在 appuser 用户下，为了有相应权限，我们的操作都在 appuser 用户下进行。</p> 
 <p>大体步骤分为：</p> 
 <ul> 
  <li>下载解压 btrace 工具；</li> 
  <li>编写监控脚本；</li> 
  <li>设置jdk/btrace 环境变量，上传脚本，编译</li> 
  <li>获取tomcat 进程号</li> 
  <li>启动监控</li> 
  <li>查看详情</li> 
 </ul> 
 <p>具体操作：</p> 
 <div> 
  <p>（1）下载btrace工具 btrace-bin-1.3.9.tgz 并解压缩</p> 
  <img src="index_files/QBvi2eI.png%21web.png" class="alignCenter"> 
 </div> 
 <p>（2） 编写一个监控脚本（java代码 UrsInterfaceCalls.java），</p> 
 <p>即需要监控的具体类和方法</p> 
 <div> 
  <div> 
   <pre class="prettyprint hljs less"><span class="hljs-variable">@BTrace</span>                         <span class="hljs-comment">// 备注1</span>
public class UrsInterfaceCalls{
	
	<span class="hljs-comment">/**
	 * 备注2
	 * 本代码用于监控 CookieDecoder 中 requestDecode 方法的执行时间，如果执行时间大于 500ms，则打印花费的时间和堆栈
	 * @param duration
	 */</span>
	<span class="hljs-variable">@OnMethod</span>(
			clazz=<span class="hljs-string">"com.netease.urs.CookieDecoder"</span>,
			method=<span class="hljs-string">"requestDecode"</span>,
			location=<span class="hljs-variable">@Location</span>(Kind.RETURN))    <span class="hljs-comment">// 备注2</span>
    public static void requestDecode( <span class="hljs-variable">@Duration</span> long duration ) {   <span class="hljs-comment">// 备注3</span>
		<span class="hljs-comment">//备注4</span>
		<span class="hljs-selector-tag">if</span>(duration /<span class="hljs-number">1000000</span> &gt; <span class="hljs-number">500</span>){
			<span class="hljs-selector-tag">println</span>(<span class="hljs-string">"==CookieDecoder requestDecode spend: "</span> + duration /<span class="hljs-number">1000000</span> + <span class="hljs-string">" ms"</span>);
			<span class="hljs-selector-tag">jstack</span>();
		}
    }
	
	<span class="hljs-comment">/**
	 * 本代码用于监控 CustomHttpComponent 中 execute 方法的执行时间，如果执行时间大于 500ms，则打印花费的时间和堆栈
	 * @param duration
	 */</span>
	@<span class="hljs-selector-tag">OnMethod</span>(
			clazz=<span class="hljs-string">"com.netease.urs.http.CustomHttpComponent"</span>,
			method=<span class="hljs-string">"execute"</span>,
			location=<span class="hljs-variable">@Location</span>(Kind.RETURN))
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">execute</span>( <span class="hljs-variable">@Duration</span> long duration ) {
		<span class="hljs-selector-tag">if</span>(duration /<span class="hljs-number">1000000</span> &gt; <span class="hljs-number">500</span>){
			<span class="hljs-selector-tag">println</span>(<span class="hljs-string">"==ursCookieHttp doExecute spend: "</span> + duration /<span class="hljs-number">1000000</span> + <span class="hljs-string">" ms"</span>);
			<span class="hljs-selector-tag">jstack</span>();
		}
    }
}
</pre> 
  </div> 
 </div> 
 <div> 
  <h4>简要说明</h4> 
  <p>本监控类，写了两个监控方法:</p> 
  <p>一个是监听CookieDecoder.requestDecode()的执行时间，如果大于 500ms，则打印日志，并打印相关堆栈；</p> 
  <p>另一个监听CustomHttpComponent.execute()的执行时间。</p> 
 </div> 
 <p> 备注1：添加注释 @BTrace ，代表本脚本将使用btrace相关功能； </p> 
 <p> 备注2：拦截方法定义 ，@OnMethod 可以指定 clazz 、 method、location。由此组成了在什么时机（location 决定）监控某个类/某些类（clazz 决定）下的某个方法/某些方法(method 决定)。 </p> 
 <div> 
  <div> 
   <pre class="prettyprint hljs less"><span class="hljs-variable">@OnMethod</span>(clazz=<span class="hljs-string">"com.netease.urs.CookieDecoder"</span>,method=<span class="hljs-string">"requestDecode"</span>,location=<span class="hljs-variable">@Location</span>(Kind.RETURN))
</pre> 
  </div> 
 </div> 
 <p>意思是监控CookieDecoder.requestDecode() ，在执行结束后（location=@Location(Kind.RETURN) 执行相关操作。</p> 
 <p> 备注3：@Duration 代表方法执行时间，纳秒。 </p> 
 <p> 备注4：只打印 耗时超过500ms的信息及堆栈，防止记录打印大多。 </p> 
 <div> 
  <h4>方法注解说明</h4> 
  <ul> 
   <li> @OnMethod:指定使用当前注解的方法应该在什么情况下触发： 
    <ul> 
     <li>claszz属性指定要匹配的类的全限定类名,可以用正则表达式;</li> 
     <li>method属性指定要匹配的方法名称,可以用正则表达式;</li> 
     <li>type属性void(java.lang.String)可以用于匹配:public void funcName(String param) 中的方法入参；</li> 
     <li>location属性用@Location来表明,匹配了clazz,method情况,在方法执行的何时去执行脚本(前,后,异常,行,某个方法调用)</li> 
    </ul> </li> 
   <li>@OnTimer:指定一个定时任务</li> 
   <li>@OnExit:当脚本运行Sys.exit(code)时触发</li> 
   <li>@OnError:当脚本运行抛出异常时触发</li> 
   <li>@OnEvent:脚本运行时Ctrl+C可以发送事件</li> 
   <li>@OnLowMemory:让你指定一个阀值,内存低于阀值触发</li> 
   <li>@OnProbe:可以用一个xml文件来描述你想在什么时候触发该方法</li> 
  </ul> 
  <h4>方法参数注解说明</h4> 
  <ul> 
   <li>@Self:目标对象本身</li> 
   <li>@Retrun:目标程序方法返回值(Kind.RETURN)</li> 
   <li>@ProbeClassName:目标类名</li> 
   <li>@ProbeMethodName:目标方法名</li> 
   <li>@targetInstance:@Location指定的clazz,method的目标(Kind.CALL)</li> 
   <li>@targetMethodOrField:@Location指定的clazz,method的目标的方法或字段(Kind.CALL)</li> 
   <li>@Duration:目标方法执行时间,单位是纳秒,需要与 Kind.RETURN 或者 Kind.ERROR 一起使用</li> 
  </ul> 
 </div> 
 <p>（3）设置jdk/btrace 环境变量 </p> 
 <div> 
  <div> 
   <pre class="prettyprint hljs bash"><span class="hljs-built_in">export</span> JAVA_HOME=/home/jdk1.8.0
<span class="hljs-built_in">export</span> JRE_HOME=/home/jdk1.8.0/jre
<span class="hljs-built_in">export</span> CLASSPATH=.:<span class="hljs-variable">${JAVA_HOME}</span>/lib:<span class="hljs-variable">${JRE_HOME}</span>/lib
<span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$JAVA_HOME</span>/bin:<span class="hljs-variable">$PATH</span>

<span class="hljs-built_in">export</span> BTRACE_HOME=/home/appuser/bTrace
<span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$BTRACE_HOME</span>/bin:<span class="hljs-variable">$PATH</span>
</pre> 
  </div> 
 </div> 
 <p>上传监控脚本 UrsInterfaceCalls.java 到服务器；</p> 
 <p>可以用 btracec 进行预编译，以保证代码无误</p> 
 <div> 
  <p>（4）获取tomcat的执行进程号 ps aux |grep “/fa.163.com”</p> 
  <img src="index_files/Zrq6ZrF.png%21web.png" class="alignCenter"> 
 </div> 
 <p>（5）进入UrsInterfaceCalls.java所在目录，启动btrace监控，监听指定进程号19504（即jvm的进程号）</p> 
 <div> 
  <div> 
   <pre class="hljs nginx"><span class="hljs-attribute">sh</span> btrace -p <span class="hljs-number">2021</span> <span class="hljs-number">19054</span>  UrsInterfaceCalls.java
</pre> 
  </div> 
 </div> 
 <p>-p 2021 ：指定一个端口号，防止多个执行导致端口冲突；</p> 
 <p>19054 ：要监听的进程号</p> 
 <p>UrsInterfaceCalls.java ：监听脚本</p> 
 <p>（6）查看结果</p> 
 <p>如果方法执行超过500ms，会打印日志，同时打印堆栈；</p> 
 <div> 
  <div> 
   <pre class="prettyprint hljs vim">==CookieDecoder requestDecode spend: <span class="hljs-number">525</span> ms
<span class="hljs-keyword">com</span>.netease.urs.CookieDecoder.requestDecode(CookieDecoder.jav<span class="hljs-variable">a:64</span>)
<span class="hljs-keyword">com</span>.netease.urs.ntescode.validate_cookie_online(ntescode.jav<span class="hljs-variable">a:49</span>)
<span class="hljs-keyword">com</span>.netease.common.util.CookieUtil.getUserInfoFromUrsRemoteCookie(CookieUtil.jav<span class="hljs-variable">a:317</span>)
<span class="hljs-keyword">com</span>.netease.lottery.service.util.CookieUtilServiceImpl.getUserInfoFromUrsRemoteCookie(CookieUtilServiceImpl.jav<span class="hljs-variable">a:88</span>)
<span class="hljs-keyword">com</span>.netease.lottery.service.util.CookieUtilServiceImpl$$FastClassByCGLIB$$<span class="hljs-number">1</span>bd66cf1.invoke(<span class="hljs-symbol">&lt;generated&gt;</span>)
org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.jav<span class="hljs-variable">a:204</span>)

.......

org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.jav<span class="hljs-variable">a:1708</span>)
java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.jav<span class="hljs-variable">a:1142</span>)
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.jav<span class="hljs-variable">a:617</span>)
org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.jav<span class="hljs-variable">a:61</span>)
java.lang.Thread.run(Thread.jav<span class="hljs-variable">a:745</span>)
</pre> 
  </div> 
 </div> 
 <p>如果要定位具体耗时，需要对各个关键方法，都添加监控脚本。</p> 
 <h3>3.2 使用Greys </h3> 
 <p>使用greys，无需编写 脚步，它是命令交互式的，直接输入命令指定监控的类、方法。</p> 
 <p>但是每次只能监控一个方法，不能像 Btrace，可以同时监控多个方法。</p> 
 <p>使用过程大体步骤：</p> 
 <ul> 
  <li>下载解压 Greys工具，安装；</li> 
  <li>设置jdk 环境变量</li> 
  <li>获取tomcat 进程号</li> 
  <li>启动监控</li> 
  <li>查看详情</li> 
 </ul> 
 <p>具体步骤：</p> 
 <p>（1）下载最新版本的Greys、解压后，执行安装命令</p> 
 <div> 
  <div> 
   <pre class="hljs vim"><span class="hljs-keyword">sh</span> ./install-local.<span class="hljs-keyword">sh</span>
</pre> 
  </div> 
 </div> 
 <p>（2）设置环境变量</p> 
 <div> 
  <div> 
   <pre class="prettyprint hljs bash"><span class="hljs-built_in">export</span> JAVA_HOME=/home/jdk1.8.0
<span class="hljs-built_in">export</span> JRE_HOME=/home/jdk1.8.0/jre
<span class="hljs-built_in">export</span> CLASSPATH=.:<span class="hljs-variable">${JAVA_HOME}</span>/lib:<span class="hljs-variable">${JRE_HOME}</span>/lib
<span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$JAVA_HOME</span>/bin:<span class="hljs-variable">$PATH</span>
</pre> 
  </div> 
 </div> 
 <p>（3）查询 jvm的进程号，进入greys安装目录，启动Greys</p> 
 <div> 
  <div> 
   <pre class="hljs vim">./greys.<span class="hljs-keyword">sh</span> <span class="hljs-number">10437</span>
</pre> 
  </div> 
 </div> 
 <p>10437 为 jvm的进程号</p> 
 <p>（4）启动后，就可以通过交互式命令方式，对指定的类、方法进行分析。</p> 
 <p>使用help 可以看到各种命令。</p> 
 <p> <img src="index_files/RVFJvu2.png%21web.png" class="alignCenter"> </p> 
 <p>（5）使用 trace命令 跟踪指定类、方法的执行时间、参数、返回值情况；</p> 
 <p>使用 help trace，查询使用方式</p> 
 <p> <img src="index_files/u2QfMny.png%21web.png" class="alignCenter"> </p> 
 <p>例如：跟踪CookieDecoder类中 requestDecode()方法耗时超过500ms 的方法执行情况：</p> 
 <div> 
  <div> 
   <pre class="prettyprint hljs nginx"><span class="hljs-attribute">trace</span>  -n <span class="hljs-number">2</span>  com.netease.urs.CookieDecoder  requestDecode    <span class="hljs-string">'#cost&gt;500'</span>
</pre> 
  </div> 
 </div> 
 <p>-n 2 ：代表只打印2次就退出（防止刷屏，影响性能）；</p> 
 <p>com.netease.urs.CookieDecoder ：监听的类名</p> 
 <p>requestDecode :监听的方法名</p> 
 <p>‘#cost&gt;500’ : 打印条件为 耗时超过 500ms</p> 
 <p>执行后，会显示：</p> 
 <div> 
  <div> 
   <pre class="prettyprint hljs vim">ga?&gt;trace  -n <span class="hljs-number">2</span>  <span class="hljs-keyword">com</span>.netease.urs.CookieDecoder  requestDecode    <span class="hljs-string">'#cost&gt;10'</span>
Press Ctrl+D <span class="hljs-keyword">to</span> abort.
Affect(class-<span class="hljs-keyword">cn</span><span class="hljs-variable">t:1</span> , method-<span class="hljs-keyword">cn</span><span class="hljs-variable">t:2</span>) cost in <span class="hljs-number">262</span> ms.
</pre> 
  </div> 
 </div> 
 <p>代表动态修改了一个类，对两个方法（例如方法重载）进行监控，修改花费262毫秒。</p> 
 <p>如果出现满足条件的情况，则我们会看到打印结果：</p> 
 <div> 
  <div> 
   <pre class="prettyprint hljs elixir">`---+Tracing <span class="hljs-keyword">for</span> : thread_name=<span class="hljs-string">"http-nio-8003-exec-8"</span> thread_id=<span class="hljs-number">0x7a</span>;is_daemon=<span class="hljs-keyword">true</span>;priority=<span class="hljs-number">5</span>;
    `---+[<span class="hljs-number">5283</span>,<span class="hljs-number">5283</span>ms]com.netease.urs.<span class="hljs-symbol">CookieDecoder:</span>requestDecode()
        +---[<span class="hljs-number">1</span>,0ms]java.lang.<span class="hljs-symbol">System:</span>nanoTime()
        +---[<span class="hljs-number">2</span>,<span class="hljs-number">1</span>ms]org.apache.http.client.methods.<span class="hljs-symbol">HttpPost:</span>&lt;init&gt;(<span class="hljs-variable">@39</span>)
        +---[<span class="hljs-number">2</span>,0ms]java.lang.<span class="hljs-symbol">StringBuffer:</span>&lt;init&gt;(<span class="hljs-variable">@41</span>)
        +---[<span class="hljs-number">2</span>,0ms]java.lang.<span class="hljs-symbol">StringBuffer:</span>append(<span class="hljs-variable">@42</span>)
        +---[<span class="hljs-number">2</span>,0ms]java.net.<span class="hljs-symbol">URLEncoder:</span>encode(<span class="hljs-variable">@43</span>)
        +---[<span class="hljs-number">2</span>,0ms]java.lang.<span class="hljs-symbol">StringBuffer:</span>append(<span class="hljs-variable">@43</span>)
        +---[<span class="hljs-number">2</span>,0ms]java.lang.<span class="hljs-symbol">StringBuffer:</span>append(<span class="hljs-variable">@44</span>)
        +---[<span class="hljs-number">2</span>,0ms]java.lang.<span class="hljs-symbol">StringBuffer:</span>append(<span class="hljs-variable">@45</span>)
        +---[<span class="hljs-number">2</span>,0ms]java.lang.<span class="hljs-symbol">StringBuffer:</span>append(<span class="hljs-variable">@46</span>)
        +---[<span class="hljs-number">2</span>,0ms]java.lang.<span class="hljs-symbol">StringBuffer:</span>append(<span class="hljs-variable">@47</span>)
        +---[<span class="hljs-number">2</span>,0ms]java.lang.<span class="hljs-symbol">StringBuffer:</span>append(<span class="hljs-variable">@48</span>)
        +---[<span class="hljs-number">2</span>,0ms]java.lang.<span class="hljs-symbol">Integer:</span>&lt;init&gt;(<span class="hljs-variable">@49</span>)
        +---[<span class="hljs-number">2</span>,0ms]java.lang.<span class="hljs-symbol">Integer:</span>&lt;init&gt;(<span class="hljs-variable">@49</span>)
        +---[<span class="hljs-number">2</span>,0ms]java.lang.reflect.<span class="hljs-symbol">Method:</span>invoke(<span class="hljs-variable">@49</span>)
        +---[<span class="hljs-number">2</span>,0ms]java.lang.<span class="hljs-symbol">StringBuffer:</span>append(<span class="hljs-variable">@49</span>)
        +---[<span class="hljs-number">2</span>,0ms]java.lang.<span class="hljs-symbol">StringBuffer:</span>toString(<span class="hljs-variable">@50</span>)
        +---[<span class="hljs-number">2</span>,0ms]org.apache.http.entity.<span class="hljs-symbol">StringEntity:</span>&lt;init&gt;(<span class="hljs-variable">@50</span>)
        +---[<span class="hljs-number">2</span>,0ms]org.apache.http.entity.<span class="hljs-symbol">StringEntity:</span>setContentType(<span class="hljs-variable">@51</span>)
        +---[<span class="hljs-number">2</span>,0ms]org.apache.http.client.methods.<span class="hljs-symbol">HttpPost:</span>setEntity(<span class="hljs-variable">@52</span>)
        +---[<span class="hljs-number">2</span>,0ms]org.apache.http.client.methods.<span class="hljs-symbol">HttpPost:</span>getParams(<span class="hljs-variable">@53</span>)
        +---[<span class="hljs-number">2</span>,0ms]org.apache.http.params.<span class="hljs-symbol">HttpParams:</span>setIntParameter(<span class="hljs-variable">@55</span>)
        +---[<span class="hljs-number">2</span>,0ms]org.apache.http.params.<span class="hljs-symbol">HttpParams:</span>setIntParameter(<span class="hljs-variable">@58</span>)
        +---[<span class="hljs-number">5282</span>,<span class="hljs-number">5280</span>ms]com.netease.urs.http.<span class="hljs-symbol">CustomHttpComponent:</span>execute(<span class="hljs-variable">@60</span>)
        +---[<span class="hljs-number">5283</span>,0ms]org.apache.http.<span class="hljs-symbol">HttpResponse:</span>getEntity(<span class="hljs-variable">@61</span>)
        +---[<span class="hljs-number">5283</span>,0ms]org.apache.http.util.<span class="hljs-symbol">EntityUtils:</span>toString(<span class="hljs-variable">@62</span>)
        +---[<span class="hljs-number">5283</span>,0ms]com.netease.urs.util.<span class="hljs-symbol">LogUtil:</span>debug(<span class="hljs-variable">@63</span>)
        +---[<span class="hljs-number">5283</span>,0ms]org.apache.http.client.methods.<span class="hljs-symbol">HttpPost:</span>releaseConnection(<span class="hljs-variable">@71</span>)
        +---[<span class="hljs-number">5283</span>,0ms]java.lang.<span class="hljs-symbol">System:</span>nanoTime(<span class="hljs-variable">@64</span>)
        `---[<span class="hljs-number">5283</span>,0ms]com.netease.urs.<span class="hljs-symbol">CookieDecoder:</span><span class="hljs-variable">$btrace</span><span class="hljs-variable">$com</span><span class="hljs-variable">$netease</span><span class="hljs-variable">$fa</span><span class="hljs-variable">$trace</span><span class="hljs-variable">$UrsInterfaceCalls</span><span class="hljs-variable">$2</span><span class="hljs-variable">$requestDecode</span>(<span class="hljs-variable">@64</span>)
</pre> 
  </div> 
 </div> 
 <p>可以看到，主要耗时在 </p> 
 <div> 
  <div> 
   <pre class="prettyprint hljs css">+<span class="hljs-selector-tag">---</span><span class="hljs-selector-attr">[5282,5280ms]</span><span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.netease</span><span class="hljs-selector-class">.urs</span><span class="hljs-selector-class">.http</span><span class="hljs-selector-class">.CustomHttpComponent</span><span class="hljs-selector-pseudo">:execute(</span>@<span class="hljs-keyword">60</span>)
</pre> 
  </div> 
 </div> 
 <p>只要一层一层跟踪下去，就可以最终定位问题。</p> 
 <p>（6）退出前可以使用 reset 恢复增强类（即被动态修改的代码）</p> 
 <p>（7）最后，使用shutdown 关闭greys 并退出</p> 
 <h2>4.总结说明 </h2> 
 <p>（1） 相比两个工具，btrace 需要手写脚步，每次更新都要重新上传再执行，而greys 支持命令式交互，无需手写脚本；</p> 
 <p>（2）btrace 脚步中，可以写多个监听类和方法，但是greys 命令同时只能输入一个。（但是greys 可以支持多个用户操作，所如果想同时监控多个方法，只能开多窗口）</p> 
 <p>（3）btrace 要确保监控脚本的正确性，使用前最好预编译，防止动态增强后影响在线功能；</p> 
 <p>（4）监控时，设置合适的条件，例如在 greys实例中，花费时间大于 N ms才输出，且只打印2个。</p> 
 <p>（5）greys 中只能显示1层的方法调用情况，无法直接跟踪到最底层；只能自己一层一层往下跟进。</p> 
</div>
        </div>
        <div class="article_social">
         <div class="article_like">
    <div class="circle circle-like" id="my_zan" data_id="7VfQZfV">  </div>

</div>
        <div id="share_weixin_image">
            <img src="index_files/qrcode.php.png" height="100px" width="100px">
        </div>
<div class="article_share_fav">
    <div class="share" id="ckepop">
        <span>分享</span>
        <button class="share_weibo" id="share_weibo_id" title="分享到新浪微博"></button>
        <button class="share_qq" id="share_qq_id" title="分享到QQ空间"></button>
        <button class="share_weixin" id="share_weixin_id"></button>
    </div>
    <div class="fav_correct">
        <button id="my_fav" data_id="7VfQZfV">
            <i class="icon icon-star-empty"></i> <span id="fav_tip">收藏</span>
        </button>
        <button id="article-correct" data_id="7VfQZfV" uid="0">
            <i class="icon icon-warning-sign"></i>
            <span>纠错</span>
        </button>
    </div>
</div>
<script type="text/javascript"><!--
/* Script removed by snapshot save */
--></script>


            <div class="bottom_plink clearfix">
                    <a href="https://dami.ksyun.com/special-product/index.html?ch=00033.00018.6666&amp;hmsr=%E6%8E%A8%E9%85%B7&amp;hmpl=special6666&amp;hmcu=&amp;hmkw=&amp;hmci=" target="_blank"><img src="index_files/ksyun774.jpg"></a>

            </div>
        </div>
        <div id="site_articles" style="clear:both;">
              <div class="article-part-title">
                <span>推荐文章</span>
              </div>
          <ul class="side_article_list">
                <li class="side_article_list_item">
                    1.<a href="https://www.tuicool.com/articles/zuumamr" target="_blank" title="无人便利店推人工智能化，与新零售的结合点在哪?">
                    无人便利店推人工智能化，与新零售的结合点在哪?
                    </a>
                </li>
                <li class="side_article_list_item">
                    2.<a href="https://www.tuicool.com/articles/jERJnm2" target="_blank" title="Dropbox创旧金山史上最大租楼交易纪录">
                    Dropbox创旧金山史上最大租楼交易纪录
                    </a>
                </li>
                <li class="side_article_list_item">
                    3.<a href="https://www.tuicool.com/articles/z2uiiqY" target="_blank" title="日媒：阿里与腾讯无所不在 中国生了垄断病！">
                    日媒：阿里与腾讯无所不在 中国生了垄断病！
                    </a>
                </li>
                <li class="side_article_list_item">
                    4.<a href="https://www.tuicool.com/articles/rqIf63R" target="_blank" title="Google 关闭涉嫌干扰美国大选的 YouTube 频道">
                    Google 关闭涉嫌干扰美国大选的 YouTube 频道
                    </a>
                </li>
                <li class="side_article_list_item">
                    5.<a href="https://www.tuicool.com/articles/bAZJf2z" target="_blank" title="惨遭看衰 动视暴雪股票遭9年来首次降级">
                    惨遭看衰 动视暴雪股票遭9年来首次降级
                    </a>
                </li>
                <li class="side_article_list_item">
                    6.<a href="https://www.tuicool.com/articles/biEnmue" target="_blank" title="2017中国最受赞赏的公司与领导者，阿里巴巴全面碾压腾讯">
                    2017中国最受赞赏的公司与领导者，阿里巴巴全面碾压腾讯
                    </a>
                </li>
          </ul>
        </div>
        <div id="kan_articles"> <div class="article-part-title"> <span>相关推刊</span></div><div class="kan-list-container"><ul class="kan-list clearfix">          <li class="kan-item">            <a href="https://www.tuicool.com/kans/4274490888" target="_blank" class="kan-item-head">              <small>by ardorleo</small>              <img class="kan-cover" src="index_files/default_kan_cover.png">            </a>            <span class="kan-detail">              <a href="https://www.tuicool.com/kans/4274490888" target="_blank">《运维》</a>              <i class="kan-num">2</i>            </span>          </li>                  <li class="kan-item">            <a href="https://www.tuicool.com/kans/189943547" target="_blank" class="kan-item-head">              <small>by fuyzh</small>              <img class="kan-cover" src="index_files/V3MNJzn.jpg%21kan.png">            </a>            <span class="kan-detail">              <a href="https://www.tuicool.com/kans/189943547" target="_blank">《默认推刊》</a>              <i class="kan-num">7</i>            </span>          </li>                  <li class="kan-item">            <a href="https://www.tuicool.com/kans/2752976832" target="_blank" class="kan-item-head">              <small>by firecream</small>              <img class="kan-cover" src="index_files/bueyey.jpg%21kan.jpg">            </a>            <span class="kan-detail">              <a href="https://www.tuicool.com/kans/2752976832" target="_blank">《java》</a>              <i class="kan-num">884</i>            </span>          </li>        </ul></div><i class="clearfix"></i></div>
        <div id="article_weibo" style="display:none;">
            <div class="article-part-title">
                <span>相关微博</span>
                <sub>
                    <a href="https://www.tuicool.com/articles/weibo_list/7VfQZfV" target="_blank">(<i id="weibo_num"></i>)</a> 
               </sub>
            </div>
            <div class="related-weibo-list"></div>
        </div>
        <div class="comments">
    <div class="comments-area">
    <div class="comments-header">
        <h5>我来评几句</h5>
        <div class="alert comment-alert alert-error" style="display:none;">
            错误
        </div>
            <textarea cols="60" rows="5" id="comment-body" placeholder="请输入评论内容..." style="resize: none;"></textarea>
            <span class="btn btn-medium btn-submit" id="comment-submit">登录后评论</span>
        <p style="margin-top: 5px;margin-left:10px;">
            已发表评论数(<span class="comment_cnt">0</span>)
        </p>
    </div>
    <div class="comments-list">
        <div class="empty-cmts alert alert-success" style="display:none;">
            没有更多评论了^^
        </div>
    </div>
    <div class="more-comments" style="display:none;">
        <a href="">更多评论</a>
    </div>
    <div class="load-fail" style="display:none;">
        评论加载失败，<a href="javascript:void(0);">重新加载</a>
    </div>
    </div>
</div>

    </div>
        <div class="span4 article_right_side">
            <div class="right_top">
    <div class="article_related_site article_detail_bg">
    <h4 class="article-part-title">相关站点</h4>
    <div class="article_related_site_body clearfix">
        <div class="logo">
            <img src="index_files/RBjIvia.png">
        </div>
        <div class="name">
            <div>
                <a href="https://www.tuicool.com/sites/RBjIvia" target="_blank"> 网易乐得技术团队</a>
            </div>
            <div>
                <div class="btn btn-success right_site_follow" id="my_follow" data_id="RBjIvia">＋订阅</div>
            </div>
        </div>
    </div>
</div>

<div id="right_site_articles" class="article_detail_bg">
    <div class="article-part-title">
        <span>热门文章</span>
    </div>
    <ul class="side_article_list">
        <li class="side_article_list_item">
            1.<a href="https://www.tuicool.com/articles/ZN36z2M" target="_blank" title="是影评网站毁了电影，还是影人自己毁了电影？"> 是影评网站毁了电影，还是影人自己毁了电影？ </a>
        </li>
        <li class="side_article_list_item">
            2.<a href="https://www.tuicool.com/articles/mQf2Ivb" target="_blank" title="决胜外卖下半场，百度外卖、饿了么双品牌策略赢面会更大"> 决胜外卖下半场，百度外卖、饿了么双品牌策略赢面会更大 </a>
        </li>
        <li class="side_article_list_item">
            3.<a href="https://www.tuicool.com/articles/zeyuAzb" target="_blank" title="国货骄傲！小米入选商务部“中国之造”"> 国货骄傲！小米入选商务部“中国之造” </a>
        </li>
        <li class="side_article_list_item">
            4.<a href="https://www.tuicool.com/articles/yu6NRnn" target="_blank" title="娱加娱乐完成新一轮融资，芒果文创基金入股"> 娱加娱乐完成新一轮融资，芒果文创基金入股 </a>
        </li>
        <li class="side_article_list_item">
            5.<a href="https://www.tuicool.com/articles/jEVBBjv" target="_blank" title="比特币涨势凌厉：越挫越勇还是回光返照？"> 比特币涨势凌厉：越挫越勇还是回光返照？ </a>
        </li>
    </ul>
</div>
      <div class="right-link" style="margin-top: 5px">
                <a href="http://sa-summit.org/?channel=tuicool" target="_blank"><img src="index_files/arcsummit320.jpg" class="oxjxijvfpjqlybkmedrs"></a>

      </div>
</div>
<div class="operate_zone">
      <div class="right-link" style="margin-top: 5px">
                <a href="https://dami.ksyun.com/special-product/index.html?ch=00033.00018.6666&amp;hmsr=%E6%8E%A8%E9%85%B7&amp;hmpl=special6666&amp;hmcu=&amp;hmkw=&amp;hmci=" target="_blank"><img src="index_files/ksyun310.jpg"></a>

      </div>
      <div class="right-link" style="margin-top: 0px">
                <a href="http://pm-summit.org/?channel=tuicool" target="_blank"><img src="index_files/pmsummit320.jpg" class="oxjxijvfpjqlybkmedrs"></a>

      </div>
      <div class="right-link" style="margin-top: 5px">
                <a href="https://www.mtyun.com/promote/d3c48068-3196-4b48-b5e4-bb87b2926806/" target="_blank"><img src="index_files/meituan311.jpg"></a>

      </div>
</div>
         </div>
</div>

<div>
   <!-- add_article to kan -->
<div id="add-article-to-kan" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <span class="add-title">收藏到推刊</span>
    <a href="#new-kan" class="btn pull-right" data-toggle="modal">创建推刊</a>
    <i class="clearfix"></i>
  </div>
  <div class="modal-body">
    <ul id="add-kan-list">
    </ul>
  </div>
  <div class="modal-footer">
    <input value="7VfQZfV" class="article-id" type="hidden"> 
    <button class="btn btn-primary pull-left add-to-btn">  收 藏  </button>
    <button class="btn" data-dismiss="modal" aria-hidden="true" style="margin-right: 15px">取消</button>
  </div>
</div>

   <div id="new-kan" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-body">
    <input name="name" id="new-kan-name" placeholder="推刊名(必填)" required="" data-validation-required-message="请填写推刊名" type="text">
    <span class="new-ness-name">请填写推刊名</span>
    <br>
    <textarea name="desc" id="desc" rows="6" placeholder="推刊描述"></textarea>
    <span class="new-ness-desc">描述不能大于100个字符!</span>
    <br>
    权限设置：<input name="type" value="1" checked="checked" type="radio"> 公开
    <input name="type" value="0" type="radio"> 仅自己可见
  </div>
  <div class="modal-footer">
    <button class="btn btn-primary pull-left create-kan-btn" disabled="disabled">创建</button>
    <button class="btn dismiss-new-kan" data-dismiss="modal" aria-hidden="true">取消</button>
  </div>
</div>


</div>
<div id="article-correct-modal" class="modal hide fade in" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="false">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
            ×
        </button>
        <h3>文章纠错</h3>
    </div>
    <div class="modal-body">
        <input value="7VfQZfV" id="article-correct-source" type="hidden">
        <div>
            <label for="article-correct-email">
                邮箱地址
            </label>
            <input id="article-correct-email" class="input-large" type="email">
        </div>
        <div>
            <label for="article-correct-select">
                错误类型
            </label>
            <select id="article-correct-select">
                <option value="正文不准确" selected="selected">正文不准确</option>
                <option value="标题不准确">标题不准确</option>
                <option value="排版有问题">排版有问题</option>
                <option value="排版有问题">主题不准确</option>
                <option value="没有分页内容">没有分页内容</option>
                <option value="图片无法显示">图片无法显示</option>
                <option value="视频无法显示">视频无法显示</option>
                <option value="与原文不一致">与原文不一致</option>
            </select>
        </div>
        <div>
            <label for="article-correct-other">
                补充信息
            </label>
            <textarea id="article-correct-other" class="span4"></textarea>
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-primary pull-right huodong_correct_submit" id="article-correct-submit">
              提交  
        </button>
    </div>
</div>
      <link rel="stylesheet" href="index_files/highlight.default.css">
      <script src="index_files/highlight.pack.js"></script>
<script type="text/javascript"><!--
/* Script removed by snapshot save */
--></script>


    <div class="loader-inner ball-pulse ball-loading-center" id="page-loading" style="display: none">
      <div></div>
      <div></div>
      <div></div>
    </div>
    <div class="read-later-alert"></div>
  </div>

        <div class="footer">
      <div class="footer-inner" style="padding-top: 50px;padding-bottom: 50px">
        <a href="https://www.tuicool.com/about" target="_blank">关于我们</a>
        <a href="https://www.tuicool.com/mobile" target="_blank">移动应用</a>
        <a href="https://www.tuicool.com/bbs/go/issues" target="_blank">意见反馈</a>
        <a target="_blank" href="https://weibo.com/tuicool2012">官方微博</a>
      </div>
    </div>
    <div style="display:none;">
      <script src="index_files/stat.php.js" language="JavaScript"></script>
    </div>

    <script type="text/javascript" src="index_files/tip.js" async=""></script>


<div class="return" title="返回顶部" style="display: none;"></div></body></html>