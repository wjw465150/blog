<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<title>【完全跨域】异步上传文件并获得返回值</title>
<meta name="GENERATOR" content="WinCHM">
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<style>
html,body { 
	/* Default Font */
	font-family: Arial, Helvetica, sans-serif;
	font-size: 11pt;
}
</style>

</head>

<body>
<P 
style="WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; COLOR: rgb(51,51,51); FONT: 16px/27px 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; MARGIN: 0px 0px 0.75em; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(254,254,254); TEXT-INDENT: 1em; -webkit-text-stroke-width: 0px">AJAX可以进行数据的异步请求，但对于<SPAN 
class=Apple-converted-space>&nbsp;</SPAN><STRONG 
style="FONT-WEIGHT: bold; TEXT-INDENT: 0px">文件</STRONG><SPAN 
class=Apple-converted-space>&nbsp;</SPAN>和<SPAN 
class=Apple-converted-space>&nbsp;</SPAN><STRONG 
style="FONT-WEIGHT: bold; TEXT-INDENT: 0px">跨域</STRONG><SPAN 
class=Apple-converted-space>&nbsp;</SPAN>问题却束手无策。</P>
<P 
style="WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; COLOR: rgb(51,51,51); FONT: 16px/27px 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; MARGIN: 0px 0px 0.75em; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(254,254,254); TEXT-INDENT: 1em; -webkit-text-stroke-width: 0px">Jsonp可以进行跨域数据的异步请求，但同样不能使用于文件。</P>
<P 
style="WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; COLOR: rgb(51,51,51); FONT: 16px/27px 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; MARGIN: 0px 0px 0.75em; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(254,254,254); TEXT-INDENT: 1em; -webkit-text-stroke-width: 0px">&lt;form&gt;表单可以进行跨域数据和文件的上传，但却会使页面跳转。</P>
<P 
style="WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; COLOR: rgb(51,51,51); FONT: 16px/27px 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; MARGIN: 0px 0px 0.75em; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(254,254,254); TEXT-INDENT: 1em; -webkit-text-stroke-width: 0px">那么如何同时实现“<SPAN 
class=Apple-converted-space>&nbsp;</SPAN><SPAN>异步</SPAN><SPAN 
class=Apple-converted-space>&nbsp;</SPAN>”+“<SPAN 
class=Apple-converted-space>&nbsp;</SPAN><SPAN>跨域</SPAN><SPAN 
class=Apple-converted-space>&nbsp;</SPAN>”+“<SPAN 
class=Apple-converted-space>&nbsp;</SPAN><SPAN>文件</SPAN><SPAN 
class=Apple-converted-space>&nbsp;</SPAN>”+“返回值”这几个特性呢？方法如下：</P>
<H4 
style="WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; COLOR: rgb(51,51,51); FONT: bold 16px/27px 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; MARGIN: 0px 0px 0.5em; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(254,254,254); TEXT-INDENT: 1em; -webkit-text-stroke-width: 0px; text-rendering: optimizelegibility">原理：</H4>
<P 
style="WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; COLOR: rgb(51,51,51); FONT: 16px/27px 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; MARGIN: 0px 0px 0.75em; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(254,254,254); TEXT-INDENT: 1em; -webkit-text-stroke-width: 0px">将&lt;form&gt;表单通过一个iframe来submit，也就是将&lt;form&gt;的target属性设置为一个iframe的id，这样&lt;form&gt;的action 
URL就会在这个iframe中<SPAN 
class=Apple-converted-space>&nbsp;</SPAN><SPAN>打开，那么服务器的返回数据也就会输出到iframe中了。最后再通过主页面与iframe之间的交互完成对返回数据的读取（这涉及到跨域问题，</SPAN><SPAN 
class=Apple-converted-space>&nbsp;</SPAN><SPAN>文章后面将介绍此问题的解决方法）。</SPAN></P>
<H4 
style="WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; COLOR: rgb(51,51,51); FONT: bold 16px/27px 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; MARGIN: 0px 0px 0.5em; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(254,254,254); TEXT-INDENT: 1em; -webkit-text-stroke-width: 0px; text-rendering: optimizelegibility">基本结构：</H4>
<P 
style="WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; COLOR: rgb(51,51,51); FONT: 16px/27px 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; MARGIN: 0px 0px 0.75em; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(254,254,254); TEXT-INDENT: 1em; -webkit-text-stroke-width: 0px"><SPAN>前端部分</SPAN><SPAN 
class=Apple-converted-space>&nbsp;</SPAN>（当前域名：www.test.com，与form中的action域名相同）</P><PRE class="prettyprint xml" style="WORD-WRAP: break-word; BORDER-TOP: 1px solid; BORDER-RIGHT: 1px solid; WHITE-SPACE: pre-wrap; WORD-SPACING: 0px; OVERFLOW-Y: auto; BORDER-BOTTOM: 1px solid; TEXT-TRANSFORM: none; WORD-BREAK: break-all; COLOR: rgb(51,51,51); PADDING-BOTTOM: 0.3em; PADDING-TOP: 0.3em; FONT: 12px/1.5em Monaco, Menlo, Consolas, 'Courier New', monospace; PADDING-LEFT: 0.3em; MARGIN: 0px 0px 1.5em; BORDER-LEFT: 1px solid; DISPLAY: block; LETTER-SPACING: normal; PADDING-RIGHT: 0.3em; BACKGROUND-COLOR: rgb(246,246,246); TEXT-INDENT: 0px; -webkit-text-stroke-width: 0px; border-radius: 4px"><SPAN class=tag style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">&lt;<SPAN class=title style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">form</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">action</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"http://www.test.com/io.php"</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">method</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"POST"</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">enctype</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"multipart/form-data"</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">target</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"upload"</SPAN>&gt;</SPAN>
<SPAN class=indent>  </SPAN><SPAN class=tag style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">&lt;<SPAN class=title style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">input</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">type</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"file"</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">name</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"upload_file"</SPAN> /&gt;</SPAN>
<SPAN class=indent>  </SPAN><SPAN class=tag style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">&lt;<SPAN class=title style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">input</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">type</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"submit"</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">value</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"开始上传"</SPAN> /&gt;</SPAN>
<SPAN class=tag style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">&lt;/<SPAN class=title style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">form</SPAN>&gt;</SPAN>
<SPAN class=tag style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">&lt;<SPAN class=title style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">iframe</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">name</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"upload"</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">style</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"display:none"</SPAN>&gt;</SPAN><SPAN class=tag style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">&lt;/<SPAN class=title style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">iframe</SPAN>&gt;</SPAN> // 注意，是name="upload"，而不是id="upload"
</PRE>
<P 
style="WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; COLOR: rgb(51,51,51); FONT: 16px/27px 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; MARGIN: 0px 0px 0.75em; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(254,254,254); TEXT-INDENT: 1em; -webkit-text-stroke-width: 0px">后台部分</P><PRE class="prettyprint php" style="WORD-WRAP: break-word; BORDER-TOP: 1px solid; BORDER-RIGHT: 1px solid; WHITE-SPACE: pre-wrap; WORD-SPACING: 0px; OVERFLOW-Y: auto; BORDER-BOTTOM: 1px solid; TEXT-TRANSFORM: none; WORD-BREAK: break-all; COLOR: rgb(51,51,51); PADDING-BOTTOM: 0.3em; PADDING-TOP: 0.3em; FONT: 12px/1.5em Monaco, Menlo, Consolas, 'Courier New', monospace; PADDING-LEFT: 0.3em; MARGIN: 0px 0px 1.5em; BORDER-LEFT: 1px solid; DISPLAY: block; LETTER-SPACING: normal; PADDING-RIGHT: 0.3em; BACKGROUND-COLOR: rgb(246,246,246); TEXT-INDENT: 0px; -webkit-text-stroke-width: 0px; border-radius: 4px"><SPAN class=preprocessor style="FONT-WEIGHT: bold; COLOR: rgb(153,153,153)">&lt;?php</SPAN>

        move_uploaded_file(<SPAN class=variable style="COLOR: rgb(0,128,128)">$_FILES</SPAN>[<SPAN class=string style="COLOR: rgb(221,17,68)">'upload_file'</SPAN>][<SPAN class=string style="COLOR: rgb(221,17,68)">'tmp_name'</SPAN>],<SPAN class=string style="COLOR: rgb(221,17,68)">'upload/'</SPAN> . <SPAN class=variable style="COLOR: rgb(0,128,128)">$_FILES</SPAN>[<SPAN class=string style="COLOR: rgb(221,17,68)">'upload_file'</SPAN>][<SPAN class=string style="COLOR: rgb(221,17,68)">'name'</SPAN>]); <SPAN class=comment style="COLOR: rgb(153,153,136); FONT-STYLE: italic">// 存储上传的文件</SPAN>

        <SPAN class=keyword style="FONT-WEIGHT: bold; COLOR: rgb(51,51,51)">echo</SPAN> <SPAN class=string style="COLOR: rgb(221,17,68)">'This data is from server!'</SPAN>; <SPAN class=comment style="COLOR: rgb(153,153,136); FONT-STYLE: italic">// 返回数据，这行字将输出到iframe的body中</SPAN>

<SPAN class=preprocessor style="FONT-WEIGHT: bold; COLOR: rgb(153,153,153)">?&gt;</SPAN></PRE>
<H4 
style="WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; COLOR: rgb(51,51,51); FONT: bold 16px/27px 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; MARGIN: 0px 0px 0.5em; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(254,254,254); TEXT-INDENT: 1em; -webkit-text-stroke-width: 0px; text-rendering: optimizelegibility">优化结构一：</H4>
<P 
style="WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; COLOR: rgb(51,51,51); FONT: 16px/27px 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; MARGIN: 0px 0px 0.75em; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(254,254,254); TEXT-INDENT: 1em; -webkit-text-stroke-width: 0px"><SPAN>前端部分</SPAN><SPAN 
class=Apple-converted-space>&nbsp;</SPAN>（当前域名：a.test.com，与form中的action域名不同）</P><PRE class="prettyprint xml" style="WORD-WRAP: break-word; BORDER-TOP: 1px solid; BORDER-RIGHT: 1px solid; WHITE-SPACE: pre-wrap; WORD-SPACING: 0px; OVERFLOW-Y: auto; BORDER-BOTTOM: 1px solid; TEXT-TRANSFORM: none; WORD-BREAK: break-all; COLOR: rgb(51,51,51); PADDING-BOTTOM: 0.3em; PADDING-TOP: 0.3em; FONT: 12px/1.5em Monaco, Menlo, Consolas, 'Courier New', monospace; PADDING-LEFT: 0.3em; MARGIN: 0px 0px 1.5em; BORDER-LEFT: 1px solid; DISPLAY: block; LETTER-SPACING: normal; PADDING-RIGHT: 0.3em; BACKGROUND-COLOR: rgb(246,246,246); TEXT-INDENT: 0px; -webkit-text-stroke-width: 0px; border-radius: 4px"><SPAN class=tag style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">&lt;<SPAN class=title style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">form</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">action</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"http://b.test.com/io.php"</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">method</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"POST"</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">enctype</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"multipart/form-data"</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">target</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"upload"</SPAN>&gt;</SPAN>
<SPAN class=indent>  </SPAN><SPAN class=tag style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">&lt;<SPAN class=title style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">input</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">type</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"file"</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">name</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"upload_file"</SPAN> /&gt;</SPAN>
<SPAN class=indent>  </SPAN><SPAN class=tag style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">&lt;<SPAN class=title style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">input</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">type</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"text"</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">name</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"script"</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">value</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"http://a.test.com/JS/iframe_control.src.js"</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">style</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"display:none"</SPAN> /&gt;</SPAN> // 注意这里！
<SPAN class=indent>  </SPAN><SPAN class=tag style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">&lt;<SPAN class=title style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">input</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">type</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"submit"</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">value</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"开始上传"</SPAN> /&gt;</SPAN>
<SPAN class=tag style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">&lt;/<SPAN class=title style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">form</SPAN>&gt;</SPAN>
<SPAN class=tag style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">&lt;<SPAN class=title style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">iframe</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">name</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"upload"</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">style</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"display:none"</SPAN>&gt;</SPAN><SPAN class=tag style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">&lt;/<SPAN class=title style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">iframe</SPAN>&gt;</SPAN> // 注意，是name="upload"，而不是id="upload"
<SPAN class=tag style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">&lt;<SPAN class=title style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">script</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">type</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"text/javascript"</SPAN>&gt;</SPAN><SPAN class=javascript>
<SPAN class=indent>  </SPAN>document.domain=<SPAN class=string style="COLOR: rgb(221,17,68)">"test.com"</SPAN>; <SPAN class=comment style="COLOR: rgb(153,153,136); FONT-STYLE: italic">// 解决与iframe之间的跨域问题</SPAN>
</SPAN><SPAN class=tag style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">&lt;/<SPAN class=title style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">script</SPAN>&gt;</SPAN>
</PRE>
<P 
style="WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; COLOR: rgb(51,51,51); FONT: 16px/27px 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; MARGIN: 0px 0px 0.75em; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(254,254,254); TEXT-INDENT: 1em; -webkit-text-stroke-width: 0px">后台部分</P><PRE class="prettyprint php" style="WORD-WRAP: break-word; BORDER-TOP: 1px solid; BORDER-RIGHT: 1px solid; WHITE-SPACE: pre-wrap; WORD-SPACING: 0px; OVERFLOW-Y: auto; BORDER-BOTTOM: 1px solid; TEXT-TRANSFORM: none; WORD-BREAK: break-all; COLOR: rgb(51,51,51); PADDING-BOTTOM: 0.3em; PADDING-TOP: 0.3em; FONT: 12px/1.5em Monaco, Menlo, Consolas, 'Courier New', monospace; PADDING-LEFT: 0.3em; MARGIN: 0px 0px 1.5em; BORDER-LEFT: 1px solid; DISPLAY: block; LETTER-SPACING: normal; PADDING-RIGHT: 0.3em; BACKGROUND-COLOR: rgb(246,246,246); TEXT-INDENT: 0px; -webkit-text-stroke-width: 0px; border-radius: 4px"><SPAN class=preprocessor style="FONT-WEIGHT: bold; COLOR: rgb(153,153,153)">&lt;?php</SPAN>
<SPAN class=indent>  </SPAN>move_uploaded_file(<SPAN class=variable style="COLOR: rgb(0,128,128)">$_FILES</SPAN>[<SPAN class=string style="COLOR: rgb(221,17,68)">'upload_file'</SPAN>][<SPAN class=string style="COLOR: rgb(221,17,68)">'tmp_name'</SPAN>],<SPAN class=string style="COLOR: rgb(221,17,68)">'upload/'</SPAN> . <SPAN class=variable style="COLOR: rgb(0,128,128)">$_FILES</SPAN>[<SPAN class=string style="COLOR: rgb(221,17,68)">'upload_file'</SPAN>][<SPAN class=string style="COLOR: rgb(221,17,68)">'name'</SPAN>]); <SPAN class=comment style="COLOR: rgb(153,153,136); FONT-STYLE: italic">// 存储上传的文件</SPAN>
<SPAN class=indent>  </SPAN><SPAN class=variable style="COLOR: rgb(0,128,128)">$html</SPAN> = <SPAN class=string style="COLOR: rgb(221,17,68)">'&lt;html&gt;&lt;head&gt;'</SPAN>
<SPAN class=indent>  </SPAN><SPAN class=indent>  </SPAN>    . <SPAN class=string style="COLOR: rgb(221,17,68)">'&lt;script src="'</SPAN> . <SPAN class=variable style="COLOR: rgb(0,128,128)">$_POST</SPAN>[<SPAN class=string style="COLOR: rgb(221,17,68)">'script'</SPAN>] .<SPAN class=string style="COLOR: rgb(221,17,68)">'" type="text/javascript"&gt;&lt;/script&gt;'</SPAN> <SPAN class=comment style="COLOR: rgb(153,153,136); FONT-STYLE: italic">// 注意这里！</SPAN>
<SPAN class=indent>  </SPAN><SPAN class=indent>  </SPAN>    . <SPAN class=string style="COLOR: rgb(221,17,68)">'&lt;/head&gt;&lt;body&gt;'</SPAN>
<SPAN class=indent>  </SPAN><SPAN class=indent>  </SPAN>    . <SPAN class=string style="COLOR: rgb(221,17,68)">'This data is from server!'</SPAN> <SPAN class=comment style="COLOR: rgb(153,153,136); FONT-STYLE: italic">// 返回数据，这行字将输出到iframe的body中</SPAN>
<SPAN class=indent>  </SPAN><SPAN class=indent>  </SPAN>    . <SPAN class=string style="COLOR: rgb(221,17,68)">'&lt;/body&gt;&lt;/html&gt;'</SPAN>;
<SPAN class=indent>  </SPAN><SPAN class=keyword style="FONT-WEIGHT: bold; COLOR: rgb(51,51,51)">echo</SPAN> <SPAN class=variable style="COLOR: rgb(0,128,128)">$html</SPAN>;
<SPAN class=preprocessor style="FONT-WEIGHT: bold; COLOR: rgb(153,153,153)">?&gt;</SPAN>
</PRE>
<P 
style="WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; COLOR: rgb(51,51,51); FONT: 16px/27px 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; MARGIN: 0px 0px 0.75em; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(254,254,254); TEXT-INDENT: 1em; -webkit-text-stroke-width: 0px">通过上面的优化，iframe从服务器接收到的内容中就多了一条&lt;script&gt;标签，这个标签的src是由&lt;form&gt;表单提交的，也就是说这个js文件可</P>
<P 
style="WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; COLOR: rgb(51,51,51); FONT: 16px/27px 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; MARGIN: 0px 0px 0.75em; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(254,254,254); TEXT-INDENT: 1em; -webkit-text-stroke-width: 0px">以放在任何域名下，并且通过修改该js的内容来制定这个iframe的功能。比如，在其中调用document.doain="test.com"后，便可以与主页面</P>
<P 
style="WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; COLOR: rgb(51,51,51); FONT: 16px/27px 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; MARGIN: 0px 0px 0.75em; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(254,254,254); TEXT-INDENT: 1em; -webkit-text-stroke-width: 0px">互相通信与控制了（主页面中也调用了document.domain="test.com"，因此跨域限制被消除了）。</P>
<H4 
style="WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; COLOR: rgb(51,51,51); FONT: bold 16px/27px 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; MARGIN: 0px 0px 0.5em; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(254,254,254); TEXT-INDENT: 1em; -webkit-text-stroke-width: 0px; text-rendering: optimizelegibility">优化结构二：</H4>
<P 
style="WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; COLOR: rgb(51,51,51); FONT: 16px/27px 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; MARGIN: 0px 0px 0.75em; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(254,254,254); TEXT-INDENT: 1em; -webkit-text-stroke-width: 0px"><SPAN>前端部分</SPAN><SPAN 
class=Apple-converted-space>&nbsp;</SPAN>（当前域名：www.a.com，与form中的action域名不同）</P><PRE class="prettyprint xml" style="WORD-WRAP: break-word; BORDER-TOP: 1px solid; BORDER-RIGHT: 1px solid; WHITE-SPACE: pre-wrap; WORD-SPACING: 0px; OVERFLOW-Y: auto; BORDER-BOTTOM: 1px solid; TEXT-TRANSFORM: none; WORD-BREAK: break-all; COLOR: rgb(51,51,51); PADDING-BOTTOM: 0.3em; PADDING-TOP: 0.3em; FONT: 12px/1.5em Monaco, Menlo, Consolas, 'Courier New', monospace; PADDING-LEFT: 0.3em; MARGIN: 0px 0px 1.5em; BORDER-LEFT: 1px solid; DISPLAY: block; LETTER-SPACING: normal; PADDING-RIGHT: 0.3em; BACKGROUND-COLOR: rgb(246,246,246); TEXT-INDENT: 0px; -webkit-text-stroke-width: 0px; border-radius: 4px"><SPAN class=tag style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">&lt;<SPAN class=title style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">form</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">action</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"http://www.b.com/io.php"</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">method</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"POST"</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">enctype</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"multipart/form-data"</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">target</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"upload"</SPAN>&gt;</SPAN>
<SPAN class=indent>  </SPAN><SPAN class=tag style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">&lt;<SPAN class=title style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">input</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">type</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"file"</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">name</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"upload_file"</SPAN> /&gt;</SPAN>
<SPAN class=indent>  </SPAN><SPAN class=tag style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">&lt;<SPAN class=title style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">input</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">type</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"text"</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">name</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"tmpurl"</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">value</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"http://www.a.com/tmp.html"</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">style</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"display:none"</SPAN> /&gt;</SPAN> //注意这里！
<SPAN class=indent>  </SPAN><SPAN class=tag style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">&lt;<SPAN class=title style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">input</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">type</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"submit"</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">value</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"开始上传"</SPAN> /&gt;</SPAN>
<SPAN class=tag style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">&lt;/<SPAN class=title style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">form</SPAN>&gt;</SPAN>
<SPAN class=tag style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">&lt;<SPAN class=title style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">iframe</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">name</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"upload"</SPAN> <SPAN class=attribute style="COLOR: rgb(0,128,128)">style</SPAN>=<SPAN class=value style="COLOR: rgb(221,17,68)">"display:none"</SPAN>&gt;</SPAN><SPAN class=tag style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">&lt;/<SPAN class=title style="FONT-WEIGHT: normal; COLOR: rgb(0,0,128)">iframe</SPAN>&gt;</SPAN> //注意，是name="upload"，而不是id="upload"
</PRE>
<P 
style="WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; COLOR: rgb(51,51,51); FONT: 16px/27px 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; MARGIN: 0px 0px 0.75em; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(254,254,254); TEXT-INDENT: 1em; -webkit-text-stroke-width: 0px">这次我们没有看到&lt;script&gt;标签，因为不再需要了，请继续看后台代码：</P>
<P 
style="WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; COLOR: rgb(51,51,51); FONT: 16px/27px 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; MARGIN: 0px 0px 0.75em; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(254,254,254); TEXT-INDENT: 1em; -webkit-text-stroke-width: 0px">后台部分</P><PRE class="prettyprint php" style="WORD-WRAP: break-word; BORDER-TOP: 1px solid; BORDER-RIGHT: 1px solid; WHITE-SPACE: pre-wrap; WORD-SPACING: 0px; OVERFLOW-Y: auto; BORDER-BOTTOM: 1px solid; TEXT-TRANSFORM: none; WORD-BREAK: break-all; COLOR: rgb(51,51,51); PADDING-BOTTOM: 0.3em; PADDING-TOP: 0.3em; FONT: 12px/1.5em Monaco, Menlo, Consolas, 'Courier New', monospace; PADDING-LEFT: 0.3em; MARGIN: 0px 0px 1.5em; BORDER-LEFT: 1px solid; DISPLAY: block; LETTER-SPACING: normal; PADDING-RIGHT: 0.3em; BACKGROUND-COLOR: rgb(246,246,246); TEXT-INDENT: 0px; -webkit-text-stroke-width: 0px; border-radius: 4px"><SPAN class=preprocessor style="FONT-WEIGHT: bold; COLOR: rgb(153,153,153)">&lt;?php</SPAN>

        move_uploaded_file(<SPAN class=variable style="COLOR: rgb(0,128,128)">$_FILES</SPAN>[<SPAN class=string style="COLOR: rgb(221,17,68)">'upload_file'</SPAN>][<SPAN class=string style="COLOR: rgb(221,17,68)">'tmp_name'</SPAN>],<SPAN class=string style="COLOR: rgb(221,17,68)">'upload/'</SPAN> . <SPAN class=variable style="COLOR: rgb(0,128,128)">$_FILES</SPAN>[<SPAN class=string style="COLOR: rgb(221,17,68)">'upload_file'</SPAN>][<SPAN class=string style="COLOR: rgb(221,17,68)">'name'</SPAN>]); <SPAN class=comment style="COLOR: rgb(153,153,136); FONT-STYLE: italic">// 存储上传的文件</SPAN>

        <SPAN class=variable style="COLOR: rgb(0,128,128)">$data</SPAN> = <SPAN class=string style="COLOR: rgb(221,17,68)">'This data is from server!'</SPAN> <SPAN class=comment style="COLOR: rgb(153,153,136); FONT-STYLE: italic">// 返回数据，这行字将通过URL返回给浏览器</SPAN>

        header(<SPAN class=string style="COLOR: rgb(221,17,68)">'Location:'</SPAN> . <SPAN class=variable style="COLOR: rgb(0,128,128)">$_POST</SPAN>[<SPAN class=string style="COLOR: rgb(221,17,68)">'tmpurl'</SPAN>] . <SPAN class=string style="COLOR: rgb(221,17,68)">'?data='</SPAN> . <SPAN class=variable style="COLOR: rgb(0,128,128)">$_data</SPAN>); <SPAN class=comment style="COLOR: rgb(153,153,136); FONT-STYLE: italic">// 上传完成后使iframe直接跳转至$_POST['tmpurl']</SPAN>

<SPAN class=preprocessor style="FONT-WEIGHT: bold; COLOR: rgb(153,153,153)">?&gt;</SPAN></PRE>
<P 
style="WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; COLOR: rgb(51,51,51); FONT: 16px/27px 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; MARGIN: 0px 0px 0.75em; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(254,254,254); TEXT-INDENT: 1em; -webkit-text-stroke-width: 0px">与优化结构一不同的是，结构二中不再使用“指定document.domain为一级域名”来解除跨域限制，也不通过iframe的document内容来得到返</P>
<P 
style="WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; COLOR: rgb(51,51,51); FONT: 16px/27px 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; MARGIN: 0px 0px 0.75em; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(254,254,254); TEXT-INDENT: 1em; -webkit-text-stroke-width: 0px">回数据，而是通过使iframe直接跳转至当前域名（通过$_POST['tmpurl']指定）来彻底取消跨域限制并且通过url的search部分传递返回数据。</P>
<H4 
style="WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; COLOR: rgb(51,51,51); FONT: bold 16px/27px 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; MARGIN: 0px 0px 0.5em; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(254,254,254); TEXT-INDENT: 1em; -webkit-text-stroke-width: 0px; text-rendering: optimizelegibility">两种结构的对比：</H4>
<P 
style="WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; COLOR: rgb(51,51,51); FONT: 16px/27px 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; MARGIN: 0px 0px 0.75em; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(254,254,254); TEXT-INDENT: 1em; -webkit-text-stroke-width: 0px">跨域：优化结构一只可解决一级域名相同的情况下的跨域情况，而优化结构二可解决任何跨域，比如百度与google之间。</P>
<P 
style="WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; COLOR: rgb(51,51,51); FONT: 16px/27px 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; MARGIN: 0px 0px 0.75em; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(254,254,254); TEXT-INDENT: 1em; -webkit-text-stroke-width: 0px">数据：优化结构一的返回数据无大小限制，而优化结构二的返回数据必须小于2K（因为数据是通过RUL传输的）。</P></body>
</html>
